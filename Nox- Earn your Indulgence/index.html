<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NOX ‚Äî Earn Your Indulgence</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Italiana&family=DM+Mono:wght@300;400;500&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">

<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NOX ‚Äî CSS FOUNDATION
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --void: #080810;
  --abyss: #0D0D1A;
  --deep: #12121F;
  --surface: #1A1A2E;
  --panel: #1F1F35;
  --raised: #252540;
  --gold: #C9A84C;
  --gold-dim: #8A6E2F;
  --gold-bright: #F0C84A;
  --ember: #E85D26;
  --jade: #2ECC8B;
  --rose: #E85D7A;
  --sky: #4A9EE8;
  --text: #F0EDE8;
  --text-mid: #9A96A8;
  --text-dim: #5A566A;
  --border: rgba(201,168,76,0.15);
  --border-bright: rgba(201,168,76,0.4);
  --glow: 0 0 40px rgba(201,168,76,0.12);
  --shadow: 0 8px 32px rgba(0,0,0,0.6);
  --radius: 12px;
  --radius-sm: 7px;
  --t: all 0.22s cubic-bezier(0.4,0,0.2,1);
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;height:100%}

body {
  font-family:'Cormorant Garamond',Georgia,serif;
  background:var(--void);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  cursor:default;
}

/* Noise grain overlay */
body::after {
  content:'';
  position:fixed;
  inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events:none;
  z-index:9998;
  opacity:0.5;
}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--abyss)}
::-webkit-scrollbar-thumb{background:var(--gold-dim);border-radius:2px}

/* ‚îÄ‚îÄ CUSTOM CURSOR ‚îÄ‚îÄ */
.pet-cursor {
  width:20px;height:20px;
  border:2px solid var(--gold);
  border-radius:50%;
  position:fixed;
  pointer-events:none;
  z-index:9997;
  transition:transform 0.1s,border-color 0.2s;
  mix-blend-mode:difference;
}

/* ‚ïê‚ïê‚ïê‚ïê AUTH PAGES ‚ïê‚ïê‚ïê‚ïê */
.auth-screen {
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}

.auth-screen.hidden{display:none}

/* Animated background stars */
.stars {
  position:absolute;
  inset:0;
  overflow:hidden;
}

.star {
  position:absolute;
  background:var(--gold);
  border-radius:50%;
  animation:twinkle var(--dur,3s) infinite var(--delay,0s);
}

@keyframes twinkle {
  0%,100%{opacity:0.1;transform:scale(1)}
  50%{opacity:0.8;transform:scale(1.3)}
}

.auth-card {
  background:var(--panel);
  border:1px solid var(--border-bright);
  border-radius:20px;
  padding:48px 44px;
  width:440px;
  max-width:95vw;
  position:relative;
  z-index:1;
  box-shadow:var(--shadow),var(--glow);
  animation:authReveal 0.7s cubic-bezier(0.4,0,0.2,1);
}

@keyframes authReveal{
  from{opacity:0;transform:translateY(30px) scale(0.96)}
  to{opacity:1;transform:translateY(0) scale(1)}
}

.auth-logo {
  text-align:center;
  margin-bottom:36px;
}

.auth-logo-text {
  font-family:'Bebas Neue',sans-serif;
  font-size:64px;
  letter-spacing:12px;
  background:linear-gradient(135deg,var(--gold-bright),var(--gold),#8A6E2F);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1;
}

.auth-logo-sub {
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:4px;
  text-transform:uppercase;
  color:var(--text-dim);
  margin-top:6px;
}

.auth-tab-row {
  display:flex;
  background:var(--surface);
  border-radius:var(--radius-sm);
  padding:3px;
  margin-bottom:28px;
}

.auth-tab {
  flex:1;
  padding:9px;
  text-align:center;
  font-family:'DM Mono',monospace;
  font-size:11px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-dim);
  border-radius:5px;
  cursor:pointer;
  transition:var(--t);
}

.auth-tab.active {
  background:var(--raised);
  color:var(--gold);
}

.auth-form{display:none}
.auth-form.active{display:block}

.form-group{margin-bottom:18px}

.form-label {
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--text-dim);
  display:block;
  margin-bottom:8px;
}

.form-input {
  width:100%;
  padding:13px 16px;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text);
  font-family:'Cormorant Garamond',serif;
  font-size:17px;
  outline:none;
  transition:var(--t);
}

.form-input:focus {
  border-color:var(--gold);
  background:var(--raised);
  box-shadow:0 0 0 3px rgba(201,168,76,0.1);
}

.form-input::placeholder{color:var(--text-dim);font-style:italic}

.referral-row {
  display:flex;
  gap:8px;
}

.referral-row .form-input{flex:1}

.ref-badge {
  background:rgba(46,204,139,0.1);
  border:1px solid rgba(46,204,139,0.3);
  color:var(--jade);
  padding:4px 10px;
  border-radius:4px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  align-self:flex-end;
  margin-bottom:1px;
  display:none;
}

.ref-badge.visible{display:block}

.btn-auth {
  width:100%;
  padding:15px;
  background:linear-gradient(135deg,var(--gold),var(--gold-dim));
  border:none;
  border-radius:var(--radius-sm);
  color:var(--void);
  font-family:'Bebas Neue',sans-serif;
  font-size:20px;
  letter-spacing:3px;
  cursor:pointer;
  transition:var(--t);
  margin-top:8px;
}

.btn-auth:hover{
  background:linear-gradient(135deg,var(--gold-bright),var(--gold));
  transform:translateY(-1px);
  box-shadow:0 8px 24px rgba(201,168,76,0.3);
}

.auth-divider {
  text-align:center;
  color:var(--text-dim);
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:2px;
  margin:20px 0;
  position:relative;
}

.auth-divider::before,.auth-divider::after {
  content:'';
  position:absolute;
  top:50%;
  width:40%;
  height:1px;
  background:var(--border);
}

.auth-divider::before{left:0}
.auth-divider::after{right:0}

.auth-error {
  background:rgba(232,93,122,0.1);
  border:1px solid rgba(232,93,122,0.3);
  color:var(--rose);
  padding:12px 16px;
  border-radius:var(--radius-sm);
  font-family:'DM Mono',monospace;
  font-size:11px;
  margin-bottom:16px;
  display:none;
}

.auth-error.visible{display:block}

/* ‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê */
.app {display:none;min-height:100vh}
.app.visible{display:flex}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar {
  width:72px;
  background:var(--abyss);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:20px 0;
  position:fixed;
  top:0;left:0;bottom:0;
  z-index:200;
  gap:4px;
}

.sidebar-logo {
  font-family:'Bebas Neue',sans-serif;
  font-size:22px;
  letter-spacing:4px;
  color:var(--gold);
  margin-bottom:20px;
  writing-mode:vertical-rl;
  text-orientation:mixed;
  transform:rotate(180deg);
}

.nav-btn {
  width:44px;height:44px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  cursor:pointer;
  transition:var(--t);
  position:relative;
  border:none;
  background:none;
  color:var(--text-dim);
}

.nav-btn:hover{background:var(--surface);color:var(--gold)}
.nav-btn.active{background:rgba(201,168,76,0.15);color:var(--gold)}

.nav-btn::after {
  content:attr(data-tip);
  position:absolute;
  left:56px;
  background:var(--panel);
  border:1px solid var(--border);
  color:var(--text);
  padding:5px 10px;
  border-radius:6px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:1px;
  white-space:nowrap;
  opacity:0;
  pointer-events:none;
  transition:var(--t);
  z-index:9999;
}

.nav-btn:hover::after{opacity:1}

.sidebar-bottom{margin-top:auto;display:flex;flex-direction:column;align-items:center;gap:8px}

.pts-bubble {
  background:var(--surface);
  border:1px solid var(--border-bright);
  border-radius:8px;
  padding:8px 6px;
  text-align:center;
  width:52px;
}

.pts-num {
  font-family:'DM Mono',monospace;
  font-size:13px;
  font-weight:500;
  color:var(--gold);
  display:block;
}

.pts-lbl {
  font-family:'DM Mono',monospace;
  font-size:7px;
  letter-spacing:1px;
  color:var(--text-dim);
  text-transform:uppercase;
}

/* ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ */
.main-content {
  margin-left:72px;
  flex:1;
  padding:32px 40px;
  min-height:100vh;
}

/* ‚îÄ‚îÄ VIEW SYSTEM ‚îÄ‚îÄ */
.view{display:none;animation:viewIn 0.3s cubic-bezier(0.4,0,0.2,1)}
.view.active{display:block}

@keyframes viewIn{
  from{opacity:0;transform:translateY(12px)}
  to{opacity:1;transform:translateY(0)}
}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.page-header {
  margin-bottom:32px;
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
}

.page-title {
  font-family:'Italiana',serif;
  font-size:44px;
  color:var(--text);
  line-height:1;
  margin-bottom:6px;
}

.page-title em{font-style:italic;color:var(--gold)}

.page-sub {
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--text-dim);
}

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.top-bar {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:32px;
  padding:14px 20px;
  background:var(--abyss);
  border:1px solid var(--border);
  border-radius:var(--radius);
}

.top-greeting {
  font-family:'Italiana',serif;
  font-size:22px;
  color:var(--text);
}

.top-greeting span{color:var(--gold)}

.top-meta {
  display:flex;
  align-items:center;
  gap:20px;
}

.top-stat {
  text-align:right;
}

.top-stat-val {
  font-family:'DM Mono',monospace;
  font-size:16px;
  font-weight:500;
  color:var(--gold);
}

.top-stat-lbl {
  font-family:'DM Mono',monospace;
  font-size:8px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-dim);
  display:block;
}

.notif-bell {
  width:36px;height:36px;
  border-radius:8px;
  background:var(--surface);
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:16px;
  transition:var(--t);
  position:relative;
}

.notif-bell:hover{border-color:var(--gold)}

.notif-dot {
  position:absolute;
  top:6px;right:6px;
  width:7px;height:7px;
  background:var(--ember);
  border-radius:50%;
  border:1.5px solid var(--abyss);
  display:none;
}

.notif-dot.on{display:block}

/* ‚ïê‚ïê‚ïê‚ïê STREAK PET ‚ïê‚ïê‚ïê‚ïê */
.pet-container {
  position:fixed;
  pointer-events:none;
  z-index:500;
  transition:none;
}

.pet-container.interactable{pointer-events:all}

.pet-wrap {
  position:relative;
  width:80px;
  cursor:pointer;
}

.pet-speech {
  position:absolute;
  bottom:100%;
  left:50%;
  transform:translateX(-50%);
  background:var(--panel);
  border:1px solid var(--border-bright);
  border-radius:10px;
  padding:6px 12px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  color:var(--gold);
  white-space:nowrap;
  pointer-events:none;
  opacity:0;
  transition:opacity 0.3s;
  margin-bottom:6px;
}

.pet-speech::after {
  content:'';
  position:absolute;
  top:100%;left:50%;
  transform:translateX(-50%);
  border:5px solid transparent;
  border-top-color:var(--border-bright);
}

.pet-speech.show{opacity:1}

.pet-name-tag {
  text-align:center;
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:1px;
  color:var(--gold);
  margin-top:2px;
  opacity:0.8;
}

/* Pet SVG animations */
.pet-svg {
  width:80px;height:80px;
  animation:petBob 2s ease-in-out infinite;
  filter:drop-shadow(0 4px 12px rgba(201,168,76,0.3));
}

@keyframes petBob {
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
}

.pet-container.running .pet-svg {
  animation:petRun 0.4s steps(4) infinite;
}

@keyframes petRun {
  0%{transform:scaleX(1) translateY(0)}
  25%{transform:scaleX(1) translateY(-4px)}
  50%{transform:scaleX(1) translateY(0)}
  75%{transform:scaleX(1) translateY(-2px)}
}

/* Pet stages */
.pet-stage-egg .pet-body{fill:#2A2040;stroke:var(--gold);stroke-width:2}
.pet-stage-hatchling .pet-body{fill:#4A3060}
.pet-stage-juvenile .pet-body{fill:#6A4080}
.pet-stage-teen .pet-body{fill:#8A5090}
.pet-stage-adult .pet-body{fill:#AA60A0}
.pet-stage-elder .pet-body{fill:#C070B0}

/* Pet eyes */
.pet-eye {
  fill:white;
  animation:blink 4s infinite;
}

@keyframes blink {
  0%,96%,100%{transform:scaleY(1)}
  98%{transform:scaleY(0.1)}
}

/* Heart particles when petted */
.heart-particle {
  position:absolute;
  font-size:16px;
  pointer-events:none;
  animation:heartFloat 1.2s cubic-bezier(0.4,0,0.2,1) forwards;
}

@keyframes heartFloat {
  0%{opacity:1;transform:translateY(0) scale(1)}
  100%{opacity:0;transform:translateY(-60px) scale(0.5)}
}

/* ‚ïê‚ïê‚ïê‚ïê POINTS SYSTEM ‚ïê‚ïê‚ïê‚ïê */
.points-banner {
  background:linear-gradient(135deg,var(--abyss) 0%,#1A1530 100%);
  border:1px solid var(--border-bright);
  border-radius:var(--radius);
  padding:24px 28px;
  margin-bottom:24px;
  display:grid;
  grid-template-columns:1fr 1fr 1fr auto;
  gap:24px;
  align-items:center;
  position:relative;
  overflow:hidden;
}

.points-banner::before {
  content:'';
  position:absolute;
  top:-40px;right:-40px;
  width:200px;height:200px;
  background:radial-gradient(circle,rgba(201,168,76,0.06) 0%,transparent 70%);
  pointer-events:none;
}

.pb-stat label {
  font-family:'DM Mono',monospace;
  font-size:8px;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--text-dim);
  display:block;
  margin-bottom:6px;
}

.pb-val {
  font-family:'Bebas Neue',sans-serif;
  font-size:36px;
  letter-spacing:2px;
  color:var(--gold);
  line-height:1;
  transition:var(--t);
}

.pb-val.flash{animation:numFlash 0.5s cubic-bezier(0.4,0,0.2,1)}

@keyframes numFlash{
  0%{transform:scale(1)}
  40%{transform:scale(1.15);color:var(--gold-bright)}
  100%{transform:scale(1)}
}

.pb-bar-wrap {
  background:var(--surface);
  height:3px;
  border-radius:2px;
  margin-top:10px;
  overflow:hidden;
}

.pb-bar {
  height:100%;
  background:linear-gradient(90deg,var(--gold-dim),var(--gold-bright));
  border-radius:2px;
  transition:width 0.8s cubic-bezier(0.4,0,0.2,1);
}

.shop-unlock-pill {
  background:var(--surface);
  border:1px solid var(--border-bright);
  border-radius:30px;
  padding:10px 18px;
  font-family:'DM Mono',monospace;
  font-size:11px;
  color:var(--text-dim);
  white-space:nowrap;
}

.shop-unlock-pill.open{
  background:rgba(46,204,139,0.1);
  border-color:rgba(46,204,139,0.4);
  color:var(--jade);
}

/* ‚ïê‚ïê‚ïê‚ïê GOALS ‚ïê‚ïê‚ïê‚ïê */
.goals-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}

.goal-card {
  background:var(--abyss);
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  padding:16px 18px;
  display:flex;
  align-items:center;
  gap:14px;
  cursor:pointer;
  transition:var(--t);
  user-select:none;
  position:relative;
  overflow:hidden;
}

.goal-card::before {
  content:'';
  position:absolute;
  left:0;top:0;bottom:0;
  width:3px;
  background:var(--border);
  transition:var(--t);
}

.goal-card:hover{
  border-color:var(--border-bright);
  transform:translateX(3px);
}

.goal-card:hover::before{background:var(--gold-dim)}

.goal-card.done {
  background:rgba(46,204,139,0.05);
  border-color:rgba(46,204,139,0.25);
}

.goal-card.done::before{background:var(--jade)}

.goal-cb {
  width:24px;height:24px;
  border:2px solid var(--border);
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
  transition:var(--t);
  font-size:12px;
}

.goal-card.done .goal-cb{
  background:var(--jade);
  border-color:var(--jade);
  color:var(--void);
}

.goal-card.done .goal-name{
  text-decoration:line-through;
  color:rgba(46,204,139,0.7);
}

.goal-name{font-size:15px;color:var(--text);flex:1}

.goal-meta {
  font-family:'DM Mono',monospace;
  font-size:9px;
  color:var(--text-dim);
  margin-top:2px;
}

.goal-pts-badge {
  font-family:'DM Mono',monospace;
  font-size:12px;
  font-weight:500;
  color:var(--gold);
  background:rgba(201,168,76,0.08);
  border:1px solid var(--border);
  padding:4px 10px;
  border-radius:20px;
  white-space:nowrap;
}

.goal-card.done .goal-pts-badge{
  color:var(--jade);
  background:rgba(46,204,139,0.08);
  border-color:rgba(46,204,139,0.2);
}

/* ‚ïê‚ïê‚ïê‚ïê FUN SHOP ‚ïê‚ïê‚ïê‚ïê */
.shop-locked-wrap {
  background:rgba(232,93,122,0.06);
  border:1px solid rgba(232,93,122,0.2);
  border-radius:var(--radius);
  padding:20px 24px;
  display:flex;
  align-items:center;
  gap:16px;
  margin-bottom:24px;
}

.shop-locked-wrap.hidden{display:none}
.shop-unlocked-banner{display:none}
.shop-unlocked-banner.show {
  display:flex;
  align-items:center;
  gap:12px;
  background:rgba(46,204,139,0.06);
  border:1px solid rgba(46,204,139,0.25);
  border-radius:var(--radius);
  padding:14px 20px;
  margin-bottom:24px;
  font-family:'DM Mono',monospace;
  font-size:12px;
  color:var(--jade);
}

.weekly-info {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:var(--abyss);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:12px 18px;
  margin-bottom:24px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  color:var(--text-dim);
}

.weekly-info span{color:var(--gold)}

.shop-grid {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}

.shop-card {
  background:var(--abyss);
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  transition:var(--t);
  cursor:pointer;
  position:relative;
  overflow:hidden;
}

.shop-card:hover:not(.depleted){
  border-color:var(--border-bright);
  transform:translateY(-3px);
  box-shadow:0 12px 32px rgba(0,0,0,0.5),var(--glow);
}

.shop-card.depleted{opacity:0.45;cursor:not-allowed}

.shop-icon{font-size:32px;margin-bottom:12px}
.shop-name{font-size:16px;color:var(--text);margin-bottom:4px}
.shop-desc{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);margin-bottom:16px;line-height:1.5}

.shop-footer{display:flex;align-items:center;justify-content:space-between}

.shop-cost{
  font-family:'DM Mono',monospace;
  font-size:14px;
  font-weight:500;
  color:var(--gold);
}

.shop-uses{
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:1px;
  color:var(--text-dim);
  background:var(--surface);
  border:1px solid var(--border);
  padding:3px 8px;
  border-radius:20px;
}

.shop-uses.warn{color:var(--ember);border-color:rgba(232,93,38,0.3)}

.redeem-btn {
  width:100%;
  margin-top:12px;
  padding:10px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--gold);
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  cursor:pointer;
  transition:var(--t);
}

.redeem-btn:hover:not(:disabled){
  background:rgba(201,168,76,0.15);
  border-color:var(--gold);
}

.redeem-btn:disabled{opacity:0.35;cursor:not-allowed;color:var(--text-dim)}

.shop-cat-label {
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:4px;
  text-transform:uppercase;
  color:var(--text-dim);
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom:1px solid var(--border);
}

/* ‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê */
.profile-header {
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:24px;
  align-items:center;
  background:var(--abyss);
  border:1px solid var(--border-bright);
  border-radius:var(--radius);
  padding:28px;
  margin-bottom:28px;
}

.avatar-ring {
  width:80px;height:80px;
  border-radius:50%;
  border:2px solid var(--gold);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:36px;
  background:var(--surface);
  position:relative;
}

.avatar-ring::after {
  content:'';
  position:absolute;
  inset:-4px;
  border-radius:50%;
  border:1px solid var(--gold-dim);
  animation:rotate 8s linear infinite;
}

@keyframes rotate{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

.profile-name{font-family:'Italiana',serif;font-size:28px;color:var(--text)}
.profile-email{font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim);margin-top:4px}
.profile-since{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-top:8px}

.profile-stats {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}

.pstat {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  text-align:center;
}

.pstat-val{font-family:'Bebas Neue',sans-serif;font-size:24px;color:var(--gold);letter-spacing:2px}
.pstat-lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-top:2px}

/* Referral section */
.referral-box {
  background:var(--abyss);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:24px;
  margin-bottom:24px;
}

.ref-title{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px}

.ref-code-display {
  display:flex;
  align-items:center;
  gap:12px;
  background:var(--surface);
  border:1.5px solid var(--border-bright);
  border-radius:var(--radius-sm);
  padding:14px 18px;
}

.ref-code-val {
  font-family:'Bebas Neue',sans-serif;
  font-size:28px;
  letter-spacing:6px;
  color:var(--gold-bright);
  flex:1;
}

.copy-btn {
  background:rgba(201,168,76,0.1);
  border:1px solid var(--border-bright);
  border-radius:6px;
  padding:8px 14px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:1px;
  color:var(--gold);
  cursor:pointer;
  transition:var(--t);
}

.copy-btn:hover{background:rgba(201,168,76,0.25)}

.ref-link {
  margin-top:10px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  color:var(--text-dim);
  word-break:break-all;
}

/* ‚ïê‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê‚ïê */
.achievements-grid {
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}

.achievement-card {
  background:var(--abyss);
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  padding:20px;
  text-align:center;
  transition:var(--t);
  position:relative;
  overflow:hidden;
}

.achievement-card.earned {
  border-color:rgba(201,168,76,0.4);
  background:linear-gradient(135deg,rgba(201,168,76,0.06) 0%,var(--abyss) 100%);
}

.achievement-card.locked{opacity:0.45}

.achievement-card::before {
  content:'';
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,rgba(201,168,76,0.05),transparent);
  opacity:0;
  transition:var(--t);
}

.achievement-card.earned::before{opacity:1}

.ach-icon{font-size:36px;margin-bottom:12px;display:block}
.ach-name{font-size:16px;color:var(--text);margin-bottom:6px}
.ach-desc{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);line-height:1.5}
.ach-pts{
  display:inline-block;
  margin-top:10px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  color:var(--gold);
  background:rgba(201,168,76,0.1);
  border:1px solid var(--border);
  padding:3px 10px;
  border-radius:20px;
}

.ach-locked-overlay {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  opacity:0.3;
}

/* ‚ïê‚ïê‚ïê‚ïê PET VIEW ‚ïê‚ïê‚ïê‚ïê */
.pet-view-center {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:24px;
}

.pet-display {
  width:200px;height:200px;
  position:relative;
}

.pet-display svg{width:100%;height:100%}

.pet-display .pet-aura {
  position:absolute;
  inset:-20px;
  border-radius:50%;
  background:radial-gradient(circle,rgba(201,168,76,0.15) 0%,transparent 70%);
  animation:aura 3s ease-in-out infinite;
}

@keyframes aura{
  0%,100%{transform:scale(1);opacity:0.8}
  50%{transform:scale(1.15);opacity:0.4}
}

.pet-actions {
  display:flex;
  gap:12px;
}

.pet-action-btn {
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  padding:14px 20px;
  text-align:center;
  cursor:pointer;
  transition:var(--t);
  min-width:120px;
}

.pet-action-btn:hover{border-color:var(--gold);background:rgba(201,168,76,0.08)}

.pet-action-icon{font-size:28px;display:block;margin-bottom:6px}
.pet-action-name{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text);display:block}
.pet-action-cost{font-family:'DM Mono',monospace;font-size:9px;color:var(--gold);margin-top:2px;display:block}

.pet-info-box {
  background:var(--abyss);
  border:1px solid var(--border-bright);
  border-radius:var(--radius);
  padding:24px;
  width:100%;
  max-width:500px;
}

.pet-stat-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 0;
  border-bottom:1px solid var(--border);
}

.pet-stat-row:last-child{border-bottom:none}
.pet-stat-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:var(--text-dim);text-transform:uppercase}
.pet-stat-val{font-family:'DM Mono',monospace;font-size:13px;color:var(--gold)}

.pet-happiness-bar {
  flex:1;
  height:4px;
  background:var(--surface);
  border-radius:2px;
  margin:0 12px;
  overflow:hidden;
}

.pet-happiness-fill{
  height:100%;
  background:linear-gradient(90deg,var(--ember),var(--gold),var(--jade));
  border-radius:2px;
  transition:width 0.6s;
}

.pet-stage-info {
  text-align:center;
  margin-bottom:16px;
}

.pet-stage-badge {
  display:inline-block;
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--gold);
  background:rgba(201,168,76,0.1);
  border:1px solid var(--border-bright);
  padding:5px 14px;
  border-radius:20px;
  margin-bottom:8px;
}

/* Pet chooser */
.pet-chooser {
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  margin-top:12px;
}

.pet-choice {
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius-sm);
  padding:12px 8px;
  text-align:center;
  cursor:pointer;
  transition:var(--t);
  font-size:28px;
}

.pet-choice:hover,.pet-choice.selected{border-color:var(--gold);background:rgba(201,168,76,0.1)}

/* ‚ïê‚ïê‚ïê‚ïê SOCIAL ‚ïê‚ïê‚ïê‚ïê */
.social-grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

.social-card {
  background:var(--abyss);
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
}

.social-header {
  background:var(--surface);
  padding:14px 18px;
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:3px;
  text-transform:uppercase;
  color:var(--gold);
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.friend-item {
  display:flex;
  align-items:center;
  gap:12px;
  padding:14px 18px;
  border-bottom:1px solid var(--border);
}

.friend-item:last-child{border-bottom:none}

.friend-avatar {
  width:36px;height:36px;
  border-radius:50%;
  background:var(--surface);
  border:1px solid var(--border-bright);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  flex-shrink:0;
}

.friend-name{font-size:15px;color:var(--text);flex:1}
.friend-pts{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold)}

.invite-input-row {
  display:flex;
  gap:8px;
  padding:16px;
}

/* ‚ïê‚ïê‚ïê‚ïê ROUTINE ‚ïê‚ïê‚ïê‚ïê */
.day-tabs {
  display:flex;
  gap:6px;
  margin-bottom:24px;
  flex-wrap:wrap;
}

.day-tab {
  padding:8px 16px;
  border:1.5px solid var(--border);
  border-radius:20px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-dim);
  cursor:pointer;
  transition:var(--t);
  background:transparent;
}

.day-tab.active{background:rgba(201,168,76,0.12);border-color:var(--gold);color:var(--gold)}

.timeline {
  position:relative;
  padding-left:80px;
}

.timeline::before {
  content:'';
  position:absolute;
  left:44px;top:0;bottom:0;
  width:1px;
  background:var(--border);
}

.tl-item {
  position:relative;
  margin-bottom:14px;
}

.tl-time {
  position:absolute;
  left:-80px;
  font-family:'DM Mono',monospace;
  font-size:10px;
  color:var(--gold);
  top:14px;
}

.tl-dot {
  position:absolute;
  left:-40px;
  width:8px;height:8px;
  background:var(--gold);
  border-radius:50%;
  border:2px solid var(--abyss);
  top:16px;
}

.tl-card {
  background:var(--abyss);
  border:1.5px solid var(--border);
  border-radius:var(--radius);
  padding:14px 18px;
  display:flex;
  align-items:center;
  gap:12px;
  transition:var(--t);
}

.tl-card:hover{border-color:var(--border-bright)}
.tc-name{font-size:15px;color:var(--text);flex:1}
.tc-note{font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:2px}
.tc-dur{font-family:'DM Mono',monospace;font-size:11px;color:var(--gold);white-space:nowrap}

/* ‚ïê‚ïê‚ïê‚ïê AI CUSTOMIZATION ‚ïê‚ïê‚ïê‚ïê */
.theme-preview {
  border:1px solid var(--border);
  border-radius:var(--radius);
  overflow:hidden;
  margin-bottom:24px;
  height:120px;
  position:relative;
  display:flex;
  align-items:center;
  justify-content:center;
}

.theme-label {
  font-family:'Bebas Neue',sans-serif;
  font-size:32px;
  letter-spacing:4px;
  z-index:1;
}

.theme-presets {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  margin-bottom:20px;
}

.theme-preset {
  border-radius:var(--radius-sm);
  padding:14px;
  cursor:pointer;
  border:2px solid transparent;
  transition:var(--t);
  text-align:center;
}

.theme-preset:hover,.theme-preset.selected{border-color:white}

.tp-name {
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:white;
  margin-top:6px;
  text-shadow:0 1px 4px rgba(0,0,0,0.8);
}

/* ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê */
.overlay {
  position:fixed;
  inset:0;
  background:rgba(8,8,16,0.85);
  backdrop-filter:blur(6px);
  z-index:1000;
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.25s;
}

.overlay.open{opacity:1;pointer-events:all}

.modal {
  background:var(--panel);
  border:1px solid var(--border-bright);
  border-radius:16px;
  padding:36px;
  width:480px;
  max-width:92vw;
  max-height:88vh;
  overflow-y:auto;
  transform:translateY(20px) scale(0.97);
  transition:transform 0.25s cubic-bezier(0.4,0,0.2,1);
  box-shadow:var(--shadow);
}

.overlay.open .modal{transform:translateY(0) scale(1)}

.modal-title{font-family:'Italiana',serif;font-size:28px;color:var(--text);margin-bottom:24px}

.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}

.btn-primary {
  background:linear-gradient(135deg,var(--gold),var(--gold-dim));
  border:none;
  border-radius:var(--radius-sm);
  padding:11px 22px;
  color:var(--void);
  font-family:'DM Mono',monospace;
  font-size:11px;
  letter-spacing:1px;
  font-weight:500;
  cursor:pointer;
  transition:var(--t);
}

.btn-primary:hover{background:linear-gradient(135deg,var(--gold-bright),var(--gold));transform:translateY(-1px)}

.btn-ghost {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:11px 22px;
  color:var(--text-mid);
  font-family:'DM Mono',monospace;
  font-size:11px;
  letter-spacing:1px;
  cursor:pointer;
  transition:var(--t);
}

.btn-ghost:hover{border-color:var(--gold);color:var(--gold)}

/* ‚ïê‚ïê‚ïê‚ïê TOASTS ‚ïê‚ïê‚ïê‚ïê */
.toast-wrap {
  position:fixed;
  bottom:24px;right:24px;
  z-index:5000;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.toast {
  background:var(--panel);
  border:1px solid var(--border-bright);
  border-left:3px solid var(--gold);
  color:var(--text);
  padding:13px 18px;
  border-radius:var(--radius-sm);
  font-family:'DM Mono',monospace;
  font-size:11px;
  letter-spacing:0.5px;
  min-width:250px;
  display:flex;
  align-items:center;
  gap:10px;
  animation:toastIn 0.3s cubic-bezier(0.4,0,0.2,1);
  box-shadow:var(--shadow);
  transition:opacity 0.4s;
}

.toast.success{border-left-color:var(--jade)}
.toast.error{border-left-color:var(--rose)}
.toast.pet{border-left-color:var(--sky)}

@keyframes toastIn{
  from{transform:translateX(80px);opacity:0}
  to{transform:translateX(0);opacity:1}
}

/* ‚ïê‚ïê‚ïê‚ïê FLOATING POINT ANIM ‚ïê‚ïê‚ïê‚ïê */
.pt-float {
  position:fixed;
  font-family:'Bebas Neue',sans-serif;
  font-size:22px;
  letter-spacing:2px;
  color:var(--gold-bright);
  pointer-events:none;
  z-index:9000;
  animation:ptFloat 1.2s cubic-bezier(0.4,0,0.2,1) forwards;
  text-shadow:0 0 20px rgba(201,168,76,0.5);
}

@keyframes ptFloat{
  0%{opacity:1;transform:translateY(0) scale(1)}
  100%{opacity:0;transform:translateY(-80px) scale(0.7)}
}

/* ‚ïê‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê‚ïê */
.empty-s {
  text-align:center;
  padding:60px 20px;
  color:var(--text-dim);
}

.empty-s .es-icon{font-size:48px;margin-bottom:16px;display:block;opacity:0.4}
.empty-s h3{font-family:'Italiana',serif;font-size:24px;color:var(--text-mid);margin-bottom:8px;font-style:italic}
.empty-s p{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px}

/* ‚ïê‚ïê‚ïê‚ïê STREAK DISPLAY ‚ïê‚ïê‚ïê‚ïê */
.streak-row {
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:24px;
}

.streak-badge {
  display:flex;
  align-items:center;
  gap:8px;
  background:rgba(201,168,76,0.08);
  border:1px solid var(--border-bright);
  border-radius:var(--radius);
  padding:12px 18px;
}

.streak-num {
  font-family:'Bebas Neue',sans-serif;
  font-size:32px;
  letter-spacing:2px;
  color:var(--gold-bright);
}

.streak-label {
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-dim);
}

.streak-calendar {
  display:flex;
  gap:4px;
  flex-wrap:wrap;
}

.sc-dot {
  width:24px;height:24px;
  border-radius:4px;
  background:var(--surface);
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:8px;
  font-family:'DM Mono',monospace;
  color:var(--text-dim);
}

.sc-dot.l1{background:rgba(201,168,76,0.2);border-color:rgba(201,168,76,0.4);color:var(--gold)}
.sc-dot.l2{background:rgba(201,168,76,0.5);border-color:var(--gold);color:var(--void)}
.sc-dot.l3{background:var(--gold);border-color:var(--gold-bright);color:var(--void)}

/* ‚ïê‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê‚ïê */
@media(max-width:900px) {
  .sidebar{width:56px}
  .main-content{margin-left:56px;padding:20px}
  .goals-grid{grid-template-columns:1fr}
  .shop-grid{grid-template-columns:1fr 1fr}
  .achievements-grid{grid-template-columns:1fr 1fr}
  .social-grid{grid-template-columns:1fr}
  .pet-chooser{grid-template-columns:repeat(4,1fr)}
}

/* AI Customize */
.ai-panel-dark {
  background:var(--abyss);
  border:1px solid var(--border-bright);
  border-radius:var(--radius);
  padding:28px;
  margin-bottom:24px;
}

.ai-inp {
  width:100%;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:var(--radius-sm);
  padding:13px 16px;
  color:var(--text);
  font-family:'Cormorant Garamond',serif;
  font-size:16px;
  outline:none;
  transition:var(--t);
  resize:vertical;
  min-height:56px;
}

.ai-inp:focus{border-color:var(--gold);background:var(--raised)}
.ai-inp::placeholder{color:var(--text-dim);font-style:italic}

.ai-quick-row {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:12px 0;
}

.ai-q {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:20px;
  padding:5px 12px;
  font-family:'DM Mono',monospace;
  font-size:9px;
  letter-spacing:1px;
  color:var(--text-dim);
  cursor:pointer;
  transition:var(--t);
}

.ai-q:hover{border-color:var(--gold);color:var(--gold)}

.ai-resp {
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:18px;
  color:var(--text);
  font-size:15px;
  line-height:1.7;
  display:none;
  margin-top:14px;
}

.ai-resp.show{display:block}

.ai-loader-row {
  display:flex;
  align-items:center;
  gap:8px;
  color:var(--text-dim);
  font-family:'DM Mono',monospace;
  font-size:11px;
}

.dot-loader span {
  display:inline-block;
  width:6px;height:6px;
  background:var(--gold);
  border-radius:50%;
  animation:dl 1.2s infinite;
  margin:0 2px;
}

.dot-loader span:nth-child(2){animation-delay:0.2s}
.dot-loader span:nth-child(3){animation-delay:0.4s}

@keyframes dl{
  0%,80%,100%{transform:scale(0.7);opacity:0.4}
  40%{transform:scale(1);opacity:1}
}

/* Section row */
.section-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--text-dim)}

.icon-btn{background:none;border:none;color:var(--text-dim);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:14px;transition:var(--t)}
.icon-btn:hover{background:var(--surface);color:var(--gold)}
.icon-btn.del:hover{color:var(--rose)}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê CUSTOM CURSOR ‚ïê‚ïê‚ïê‚ïê -->
<div class="pet-cursor" id="cursor"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê STREAK PET (floating, runs on screen) ‚ïê‚ïê‚ïê‚ïê -->
<div class="pet-container interactable" id="pet-container" onclick="openPetInteract()">
  <div class="pet-wrap">
    <div class="pet-speech" id="pet-speech"></div>
    <svg class="pet-svg" id="pet-svg" viewBox="0 0 80 80"><!-- dynamically set --></svg>
    <div class="pet-name-tag" id="pet-name-tag">?</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê‚ïê‚ïê -->
<div class="auth-screen" id="auth-screen">
  <div class="stars" id="stars-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-text">NOX</div>
      <div class="auth-logo-sub">Earn Your Indulgence</div>
    </div>

    <div class="auth-tab-row">
      <div class="auth-tab active" onclick="switchAuthTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchAuthTab('register')">Register</div>
    </div>

    <div class="auth-error" id="auth-error"></div>

    <!-- LOGIN -->
    <div class="auth-form active" id="form-login">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn-auth" onclick="doLogin()">Enter</button>
    </div>

    <!-- REGISTER -->
    <div class="auth-form" id="form-register">
      <div class="form-group">
        <label class="form-label">Display Name</label>
        <input class="form-input" id="reg-name" type="text" placeholder="Your name">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input class="form-input" id="reg-email" type="email" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="reg-pass" type="password" placeholder="Min 6 characters">
      </div>
      <div class="form-group">
        <label class="form-label">Referral Code (optional)</label>
        <div class="referral-row">
          <input class="form-input" id="reg-ref" type="text" placeholder="e.g. NOX-A1B2C3" maxlength="10" oninput="checkRefCode()">
          <div class="ref-badge" id="ref-badge">‚úì +50 pts</div>
        </div>
      </div>
      <button class="btn-auth" onclick="doRegister()">Create Account</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê -->
<div class="app" id="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">NOX</div>
    <button class="nav-btn active" data-view="daily" data-tip="DAILY GOALS" onclick="nav('daily')">‚ú¶</button>
    <button class="nav-btn" data-view="routine" data-tip="ROUTINE" onclick="nav('routine')">‚ó∑</button>
    <button class="nav-btn" data-view="shop" data-tip="FUN SHOP" onclick="nav('shop')">‚óà</button>
    <button class="nav-btn" data-view="pet" data-tip="STREAK PET" onclick="nav('pet')">üêæ</button>
    <button class="nav-btn" data-view="achievements" data-tip="ACHIEVEMENTS" onclick="nav('achievements')">üèÜ</button>
    <button class="nav-btn" data-view="social" data-tip="SOCIAL" onclick="nav('social')">üë•</button>
    <button class="nav-btn" data-view="profile" data-tip="PROFILE" onclick="nav('profile')">‚óé</button>
    <button class="nav-btn" data-view="customize" data-tip="CUSTOMIZE" onclick="nav('customize')">‚úß</button>
    <div class="sidebar-bottom">
      <div class="pts-bubble">
        <span class="pts-num" id="sb-pts">0</span>
        <span class="pts-lbl">pts</span>
      </div>
      <button class="nav-btn" data-tip="SIGN OUT" onclick="doLogout()" style="font-size:16px">‚èª</button>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-content">

    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="top-greeting">Good <span id="greeting-time">morning</span>, <span id="greeting-name">Warrior</span></div>
      <div class="top-meta">
        <div class="top-stat">
          <div class="top-stat-val" id="tb-streak">0üî•</div>
          <span class="top-stat-lbl">Streak</span>
        </div>
        <div class="top-stat">
          <div class="top-stat-val" id="tb-pts">0</div>
          <span class="top-stat-lbl">Points</span>
        </div>
        <div class="notif-bell" onclick="toggleNotifPanel()" title="Notifications">
          üîî
          <div class="notif-dot" id="notif-dot"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ DAILY GOALS VIEW ‚îÄ‚îÄ -->
    <div class="view active" id="view-daily">
      <div class="page-header">
        <div>
          <div class="page-title">Today's <em>Mission</em></div>
          <div class="page-sub">Complete goals ¬∑ Earn points ¬∑ Indulge consciously</div>
        </div>
        <button class="btn-primary" onclick="openModal('add-goal')">+ Goal</button>
      </div>

      <!-- Points banner -->
      <div class="points-banner">
        <div class="pb-stat">
          <label>Points Earned</label>
          <div class="pb-val" id="pb-earned">0</div>
          <div class="pb-bar-wrap"><div class="pb-bar" id="pb-bar" style="width:0%"></div></div>
        </div>
        <div class="pb-stat">
          <label>Goals Done</label>
          <div class="pb-val" id="pb-done">0/0</div>
        </div>
        <div class="pb-stat">
          <label>Daily Max</label>
          <div class="pb-val">100</div>
        </div>
        <div class="shop-unlock-pill" id="unlock-pill">üîí Need <span id="need-pts">60</span> pts</div>
      </div>

      <!-- Streak row -->
      <div class="streak-row">
        <div class="streak-badge">
          <div>
            <div class="streak-num" id="streak-num">0</div>
            <div class="streak-label">Day Streak</div>
          </div>
          <span style="font-size:28px">üî•</span>
        </div>
        <div class="streak-calendar" id="streak-cal"></div>
      </div>

      <div class="section-row">
        <span class="section-lbl">Goals</span>
        <span style="font-family:'DM Mono',monospace;font-size:9px;color:var(--text-dim)" id="daily-reset-lbl">resets at midnight</span>
      </div>
      <div class="goals-grid" id="goals-container"></div>
    </div>

    <!-- ‚îÄ‚îÄ ROUTINE VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-routine">
      <div class="page-header">
        <div>
          <div class="page-title">Daily <em>Ritual</em></div>
          <div class="page-sub">Structure your time ¬∑ Build your system</div>
        </div>
        <button class="btn-primary" onclick="openModal('add-routine')">+ Block</button>
      </div>
      <div class="day-tabs" id="day-tabs">
        <div class="day-tab active" data-day="Mon" onclick="setDay('Mon',this)">Mon</div>
        <div class="day-tab" data-day="Tue" onclick="setDay('Tue',this)">Tue</div>
        <div class="day-tab" data-day="Wed" onclick="setDay('Wed',this)">Wed</div>
        <div class="day-tab" data-day="Thu" onclick="setDay('Thu',this)">Thu</div>
        <div class="day-tab" data-day="Fri" onclick="setDay('Fri',this)">Fri</div>
        <div class="day-tab" data-day="Sat" onclick="setDay('Sat',this)">Sat</div>
        <div class="day-tab" data-day="Sun" onclick="setDay('Sun',this)">Sun</div>
      </div>
      <div class="timeline" id="routine-container"></div>
    </div>

    <!-- ‚îÄ‚îÄ FUN SHOP VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-shop">
      <div class="page-header">
        <div>
          <div class="page-title">Fun <em>Shop</em></div>
          <div class="page-sub">Earn it ¬∑ Redeem it ¬∑ 2√ó per item per week</div>
        </div>
        <button class="btn-primary" onclick="openModal('add-shop')">+ Item</button>
      </div>
      <div class="shop-locked-wrap" id="shop-locked">
        <span style="font-size:28px">üîí</span>
        <div>
          <div style="font-family:'DM Mono',monospace;font-size:13px;color:var(--rose);margin-bottom:4px">Shop Locked</div>
          <div style="font-size:14px;color:var(--text-dim)">Earn <strong id="shop-need" style="color:var(--text)">60</strong> points today to unlock indulgence.</div>
        </div>
      </div>
      <div class="shop-unlocked-banner" id="shop-open">‚ú¶ <span>Fun Shop open ‚Äî You've earned your indulgence.</span></div>
      <div class="weekly-info">
        <span>Resets every <strong>Saturday ¬∑ 11:59 PM</strong></span>
        <span id="reset-cd" style="color:var(--gold)">‚Äî</span>
      </div>
      <div id="shop-container"></div>
    </div>

    <!-- ‚îÄ‚îÄ PET VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-pet">
      <div class="page-header">
        <div>
          <div class="page-title">Streak <em>Companion</em></div>
          <div class="page-sub">Your loyal partner in discipline</div>
        </div>
      </div>

      <div class="pet-view-center">
        <div class="pet-stage-info">
          <div class="pet-stage-badge" id="pet-stage-badge">EGG</div>
          <div style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);margin-top:6px" id="pet-next-stage">Hatches at streak 5</div>
        </div>

        <div class="pet-display">
          <div class="pet-aura"></div>
          <svg viewBox="0 0 160 160" id="pet-view-svg"></svg>
        </div>

        <div class="pet-actions">
          <div class="pet-action-btn" onclick="petAction('feed')">
            <span class="pet-action-icon">üçñ</span>
            <span class="pet-action-name">Feed</span>
            <span class="pet-action-cost">‚àí5 pts</span>
          </div>
          <div class="pet-action-btn" onclick="petAction('pet')">
            <span class="pet-action-icon">ü§≤</span>
            <span class="pet-action-name">Pet</span>
            <span class="pet-action-cost">‚àí3 pts</span>
          </div>
          <div class="pet-action-btn" onclick="petAction('play')">
            <span class="pet-action-icon">‚öΩ</span>
            <span class="pet-action-name">Play</span>
            <span class="pet-action-cost">‚àí8 pts</span>
          </div>
        </div>

        <div class="pet-info-box">
          <div style="margin-bottom:16px">
            <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:12px">Pet Details</div>
            <div class="pet-stat-row">
              <span class="pet-stat-lbl">Name</span>
              <div style="display:flex;align-items:center;gap:8px">
                <span class="pet-stat-val" id="pet-name-disp">Unnamed</span>
                <button class="icon-btn" onclick="renamePet()" style="font-size:12px">‚úé</button>
              </div>
            </div>
            <div class="pet-stat-row">
              <span class="pet-stat-lbl">Happiness</span>
              <div class="pet-happiness-bar"><div class="pet-happiness-fill" id="pet-happiness" style="width:80%"></div></div>
              <span class="pet-stat-val" id="pet-hap-num">80%</span>
            </div>
            <div class="pet-stat-row">
              <span class="pet-stat-lbl">Stage</span>
              <span class="pet-stat-val" id="pet-stage-txt">Egg</span>
            </div>
            <div class="pet-stat-row">
              <span class="pet-stat-lbl">Next Growth</span>
              <span class="pet-stat-val" id="pet-next-txt">5 streaks</span>
            </div>
            <div class="pet-stat-row">
              <span class="pet-stat-lbl">Bonus Points</span>
              <span class="pet-stat-val" id="pet-bonus-txt">+10 every 10 streak</span>
            </div>
          </div>

          <div>
            <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:12px">Choose Pet Type</div>
            <div class="pet-chooser" id="pet-chooser">
              <div class="pet-choice" onclick="choosePet('cat')" data-type="cat">üê±</div>
              <div class="pet-choice" onclick="choosePet('dog')" data-type="dog">üê∂</div>
              <div class="pet-choice" onclick="choosePet('dragon')" data-type="dragon">üê≤</div>
              <div class="pet-choice" onclick="choosePet('fox')" data-type="fox">ü¶ä</div>
              <div class="pet-choice" onclick="choosePet('rabbit')" data-type="rabbit">üê∞</div>
              <div class="pet-choice" onclick="choosePet('penguin')" data-type="penguin">üêß</div>
              <div class="pet-choice" onclick="choosePet('wolf')" data-type="wolf">üê∫</div>
              <div class="pet-choice" onclick="choosePet('bear')" data-type="bear">üêª</div>
              <div class="pet-choice" onclick="choosePet('custom')" data-type="custom">üì∏</div>
              <div class="pet-choice" onclick="choosePet('unicorn')" data-type="unicorn">ü¶Ñ</div>
            </div>
            <input type="file" id="pet-upload" accept="image/*" style="display:none" onchange="uploadPetImage(this)">
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ACHIEVEMENTS VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-achievements">
      <div class="page-header">
        <div>
          <div class="page-title">Your <em>Achievements</em></div>
          <div class="page-sub">Unlocked through discipline and consistency</div>
        </div>
        <button class="btn-primary" onclick="generateAchievements()">‚úß Generate with AI</button>
      </div>
      <div class="achievements-grid" id="achievements-container"></div>
    </div>

    <!-- ‚îÄ‚îÄ SOCIAL VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-social">
      <div class="page-header">
        <div>
          <div class="page-title">Your <em>Circle</em></div>
          <div class="page-sub">Invite ¬∑ Compete ¬∑ Rise together</div>
        </div>
      </div>

      <div class="referral-box">
        <div class="ref-title">Your Referral Code</div>
        <div class="ref-code-display">
          <div class="ref-code-val" id="my-ref-code">NOX-???</div>
          <button class="copy-btn" onclick="copyRefCode()">Copy</button>
          <button class="copy-btn" onclick="shareRefLink()">Share Link</button>
        </div>
        <div class="ref-link" id="ref-link-display"></div>
        <div style="margin-top:14px;font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim)">
          <span style="color:var(--jade)">+50 pts</span> when someone registers with your code
        </div>
      </div>

      <div class="social-grid">
        <div class="social-card">
          <div class="social-header">
            <span>Friends</span>
            <button class="btn-primary" style="padding:5px 12px;font-size:9px" onclick="openModal('invite')">Invite</button>
          </div>
          <div id="friends-list">
            <div class="empty-s" style="padding:30px">
              <span class="es-icon">üë•</span>
              <h3>No friends yet</h3>
              <p>Share your referral code to add friends</p>
            </div>
          </div>
        </div>

        <div class="social-card">
          <div class="social-header"><span>Leaderboard</span></div>
          <div id="leaderboard-list"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ PROFILE VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-profile">
      <div class="page-header">
        <div>
          <div class="page-title">Your <em>Profile</em></div>
          <div class="page-sub">Track your growth ¬∑ See your story</div>
        </div>
      </div>

      <div class="profile-header">
        <div class="avatar-ring" id="profile-avatar">?</div>
        <div>
          <div class="profile-name" id="profile-name">‚Äî</div>
          <div class="profile-email" id="profile-email">‚Äî</div>
          <div class="profile-since" id="profile-since">Member since ‚Äî</div>
        </div>
        <div class="profile-stats">
          <div class="pstat">
            <div class="pstat-val" id="stat-streak">0</div>
            <div class="pstat-lbl">Streak</div>
          </div>
          <div class="pstat">
            <div class="pstat-val" id="stat-total-pts">0</div>
            <div class="pstat-lbl">Total Pts</div>
          </div>
          <div class="pstat">
            <div class="pstat-val" id="stat-goals-done">0</div>
            <div class="pstat-lbl">Goals Done</div>
          </div>
          <div class="pstat">
            <div class="pstat-val" id="stat-best-streak">0</div>
            <div class="pstat-lbl">Best Streak</div>
          </div>
          <div class="pstat">
            <div class="pstat-val" id="stat-referrals">0</div>
            <div class="pstat-lbl">Referrals</div>
          </div>
          <div class="pstat">
            <div class="pstat-val" id="stat-ach">0</div>
            <div class="pstat-lbl">Achievements</div>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div style="background:var(--abyss);border:1px solid var(--border);border-radius:var(--radius);padding:24px">
          <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px">Edit Profile</div>
          <div class="form-group">
            <label class="form-label">Display Name</label>
            <input class="form-input" id="edit-name" placeholder="Your name">
          </div>
          <div class="form-group">
            <label class="form-label">Avatar Emoji</label>
            <input class="form-input" id="edit-avatar" placeholder="üî•" maxlength="2">
          </div>
          <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
        </div>

        <div style="background:var(--abyss);border:1px solid var(--border);border-radius:var(--radius);padding:24px">
          <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold);margin-bottom:16px">Notifications</div>
          <div style="display:flex;flex-direction:column;gap:12px">
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <input type="checkbox" id="notif-daily" onchange="saveNotifSettings()" style="accent-color:var(--gold)">
              <span style="font-size:14px">Daily goal reminder (9am)</span>
            </label>
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <input type="checkbox" id="notif-streak" onchange="saveNotifSettings()" style="accent-color:var(--gold)">
              <span style="font-size:14px">Streak reminder (8pm)</span>
            </label>
            <label style="display:flex;align-items:center;gap:12px;cursor:pointer">
              <input type="checkbox" id="notif-reset" onchange="saveNotifSettings()" style="accent-color:var(--gold)">
              <span style="font-size:14px">Shop reset notification</span>
            </label>
            <button class="btn-primary" onclick="requestNotifPermission()" style="margin-top:8px">Enable Push Notifications</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ CUSTOMIZE VIEW ‚îÄ‚îÄ -->
    <div class="view" id="view-customize">
      <div class="page-header">
        <div>
          <div class="page-title">Customize <em>NOX</em></div>
          <div class="page-sub">Make it yours ‚Äî AI-powered theme generation</div>
        </div>
      </div>

      <div class="ai-panel-dark">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
          <div style="width:36px;height:36px;border-radius:50%;background:rgba(201,168,76,0.15);border:1px solid var(--border-bright);display:flex;align-items:center;justify-content:center;font-size:18px">‚úß</div>
          <div>
            <div style="font-family:'Italiana',serif;font-size:18px;color:var(--text)">AI Theme Studio</div>
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim)">Powered by Claude</span>
          </div>
        </div>

        <div class="ai-quick-row">
          <div class="ai-q" onclick="aiThemePrompt('Midnight forest ‚Äî deep greens, silver moonlight, ethereal mist')">üå≤ Forest Night</div>
          <div class="ai-q" onclick="aiThemePrompt('Cherry blossom ‚Äî soft pinks, ivory whites, delicate petals')">üå∏ Sakura</div>
          <div class="ai-q" onclick="aiThemePrompt('Cyberpunk neon ‚Äî electric blues, hot pinks, glowing circuits')">‚ö° Cyberpunk</div>
          <div class="ai-q" onclick="aiThemePrompt('Ancient Rome ‚Äî marble whites, terracotta, imperial gold')">üèõÔ∏è Imperial</div>
          <div class="ai-q" onclick="aiThemePrompt('Deep ocean ‚Äî abyssal blacks, bioluminescent teals, coral accents')">üåä Abyss</div>
          <div class="ai-q" onclick="aiThemePrompt('Coffee shop ‚Äî warm browns, cream whites, cinnamon highlights')">‚òï Caf√©</div>
        </div>

        <textarea class="ai-inp" id="theme-prompt" placeholder="Describe your dream aesthetic... e.g. 'Dark academia vibes, worn leather books, candlelight, rich burgundy and aged gold'" rows="3"></textarea>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button class="btn-primary" onclick="generateTheme()">Generate Theme ‚Üí</button>
          <button class="btn-ghost" onclick="resetTheme()">Reset to NOX Default</button>
          <button class="btn-ghost" onclick="saveApiKey()">Set API Key</button>
        </div>

        <div class="ai-resp" id="theme-resp"></div>
      </div>

      <div style="background:var(--abyss);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:24px">
        <div class="form-group" style="margin-bottom:0">
          <label class="form-label">Anthropic API Key</label>
          <input type="password" class="form-input" id="api-key-inp" placeholder="sk-ant-..." style="font-family:'DM Mono',monospace;font-size:13px">
        </div>
        <button class="btn-primary" onclick="saveApiKey()" style="margin-top:12px">Save Key</button>
        <span style="font-family:'DM Mono',monospace;font-size:10px;color:var(--text-dim);margin-left:12px">Stored locally only</span>
      </div>

      <!-- Customize goals and shop -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div style="background:var(--abyss);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
          <div style="background:var(--surface);padding:14px 18px;display:flex;align-items:center;justify-content:space-between">
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold)">Daily Goals</span>
            <button class="btn-primary" style="padding:5px 12px;font-size:9px" onclick="openModal('add-goal')">+ Add</button>
          </div>
          <div id="cust-goals"></div>
          <div style="padding:12px 16px">
            <div style="font-family:'DM Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text-dim);margin-bottom:8px">Shop Threshold</div>
            <div style="display:flex;gap:8px">
              <input type="number" class="form-input" id="thr-inp" min="0" max="100" value="60" style="font-size:15px">
              <button class="btn-primary" onclick="saveThreshold()">Set</button>
            </div>
          </div>
        </div>

        <div style="background:var(--abyss);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
          <div style="background:var(--surface);padding:14px 18px;display:flex;align-items:center;justify-content:space-between">
            <span style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--gold)">Fun Shop</span>
            <button class="btn-primary" style="padding:5px 12px;font-size:9px" onclick="openModal('add-shop')">+ Add</button>
          </div>
          <div id="cust-shop"></div>
        </div>
      </div>
    </div>

  </div><!-- /main-content -->
</div><!-- /app -->

<!-- ‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="overlay" onclick="closeOverlay(event)">
  <div class="modal" id="modal"><div id="modal-body"></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê TOASTS ‚ïê‚ïê‚ïê‚ïê -->
<div class="toast-wrap" id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';

// ‚îÄ‚îÄ YOUR FIREBASE CONFIG ‚îÄ‚îÄ
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBbtA9buo-Iq9FbYUYMIaK5r3RjRU4qNG4",
  authDomain: "nox-app-513eb.firebaseapp.com",
  projectId: "nox-app-513eb",
  storageBucket: "nox-app-513eb.firebasestorage.app",
  messagingSenderId: "1089846340821",
  appId: "1:1089846340821:web:653788ea4b63f91f16c65c",
  measurementId: "G-PD93C232ZD"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window._fb = { auth, db, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile };

onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    await loadUserData(user.uid);
    showApp();
  } else {
    currentUser = null;
    showAuth();
  }
});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê APP LOGIC ‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOX ‚Äî CORE ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentUser = null;
let state = {
  points: 0, threshold: 60, goals: [], completedToday: [],
  shopItems: [], weeklyRedemptions: {}, routine: [], currentDay: 'Mon',
  streak: 0, bestStreak: 0, lastCheckIn: '', lastWeekReset: '',
  totalPoints: 0, totalGoalsDone: 0,
  pet: { name: 'Noxie', type: 'cat', happiness: 80, stage: 0, customImage: null },
  achievements: [], profile: { displayName: '', avatar: 'üî•', email: '' },
  referralCode: '', referrals: [], friends: [], theme: null,
  notifSettings: { daily: false, streak: false, reset: false }
};
let petX = 200, petY = 300, petDX = 1.2, petDY = 0.8;
let petRunInterval = null;
let unsubscribe = null;

const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

const PET_STAGES = [
  { name: 'Egg',        threshold: 0,   icon: 'ü•ö', emoji: 'ü•ö' },
  { name: 'Hatchling',  threshold: 5,   icon: 'üê£', emoji: 'üê£' },
  { name: 'Juvenile',   threshold: 20,  icon: 'üê•', emoji: 'üê•' },
  { name: 'Teen',       threshold: 50,  icon: 'üê¶', emoji: 'üê¶' },
  { name: 'Adult',      threshold: 115, icon: 'ü¶Ö', emoji: 'ü¶Ö' },
  { name: 'Elder',      threshold: 230, icon: 'ü¶ã', emoji: 'ü¶ã' },
  { name: 'Legend',     threshold: 500, icon: 'üêâ', emoji: 'üêâ' },
];

const PET_EMOJIS = { cat:'üê±', dog:'üê∂', dragon:'üê≤', fox:'ü¶ä', rabbit:'üê∞', penguin:'üêß', wolf:'üê∫', bear:'üêª', unicorn:'ü¶Ñ' };

const DEFAULT_GOALS = [
  {id:'g1',name:'Study',points:18,category:'Core',note:'Deep work session'},
  {id:'g2',name:'Extra Skill',points:15,category:'Core',note:'HTML/CSS/Python/JS'},
  {id:'g3',name:'AI Concept',points:12,category:'Core',note:''},
  {id:'g4',name:'Exercise (2h gym)',points:12,category:'Health',note:''},
  {id:'g5',name:'Eat Healthy',points:10,category:'Health',note:''},
  {id:'g6',name:'Drink Water (3L)',points:5,category:'Health',note:''},
  {id:'g7',name:'Meditation',points:5,category:'Health',note:''},
  {id:'g8',name:'Violin',points:6,category:'Skills',note:''},
  {id:'g9',name:'Japanese',points:6,category:'Skills',note:''},
  {id:'g10',name:'Drawing',points:5,category:'Skills',note:''},
  {id:'g11',name:'Typing Practice',points:6,category:'Skills',note:''},
];

const DEFAULT_SHOP = [
  {id:'s1',name:'Friends Hangout',cost:60,category:'Entertainment',icon:'üë•',desc:'Fun activity with friends'},
  {id:'s2',name:'Anime Episode',cost:10,category:'Entertainment',icon:'üéå',desc:'One episode'},
  {id:'s3',name:'Social Media',cost:20,category:'Entertainment',icon:'üì±',desc:'15 minutes'},
  {id:'s4',name:'Genshin Impact',cost:45,category:'Entertainment',icon:'‚öîÔ∏è',desc:'1 hour gameplay'},
  {id:'s5',name:'Manhwa',cost:25,category:'Entertainment',icon:'üìñ',desc:'10 chapters'},
  {id:'s6',name:'Skip 1 Task',cost:80,category:'Control',icon:'‚è≠Ô∏è',desc:'Any non-gym task'},
  {id:'s7',name:'Skip Gym',cost:100,category:'Control',icon:'üõãÔ∏è',desc:'Full gym skip'},
  {id:'s8',name:'Junk Food',cost:200,category:'Indulgence',icon:'üçî',desc:'One meal'},
  {id:'s9',name:'Buy Something',cost:120,category:'Indulgence',icon:'üõçÔ∏è',desc:'Small purchase'},
  {id:'s10',name:'Lazy Evening',cost:90,category:'Indulgence',icon:'üåô',desc:'Unstructured evening'},
  {id:'s11',name:'Day Off',cost:250,category:'Indulgence',icon:'‚òÄÔ∏è',desc:'Full planned day off'},
];

const DEFAULT_ACHIEVEMENTS = [
  {id:'a1',name:'First Blood',desc:'Complete your first daily goal',icon:'‚öîÔ∏è',pts:10,earned:false,condition:'goals_done>=1'},
  {id:'a2',name:'Dawn Warrior',desc:'Earn 100 points in a single day',icon:'üåÖ',pts:25,earned:false,condition:'daily_pts>=100'},
  {id:'a3',name:'Seven Days',desc:'Maintain a 7-day streak',icon:'üî•',pts:50,earned:false,condition:'streak>=7'},
  {id:'a4',name:'Iron Will',desc:'Reach a 30-day streak',icon:'üõ°Ô∏è',pts:150,earned:false,condition:'streak>=30'},
  {id:'a5',name:'The Recruiter',desc:'Invite a friend who joins',icon:'üëë',pts:75,earned:false,condition:'referrals>=1'},
  {id:'a6',name:'Pet Parent',desc:'Name your streak pet',icon:'üêæ',pts:15,earned:false,condition:'pet_named'},
  {id:'a7',name:'Dragon Tamer',desc:'Reach Legend pet stage',icon:'üêâ',pts:200,earned:false,condition:'pet_stage>=6'},
  {id:'a8',name:'Disciplined',desc:'Complete all goals for 3 days straight',icon:'‚ú¶',pts:80,earned:false,condition:'perfect_days>=3'},
  {id:'a9',name:'The Abstinent',desc:'Go 7 days without redeeming Fun Shop',icon:'üîí',pts:100,earned:false,condition:'no_shop_7days'},
];

const DEFAULT_ROUTINE = [
  {id:'r1',day:'Mon',time:'06:00',title:'Morning Ritual',duration:'30 min',note:'Water, stretch, meditate'},
  {id:'r2',day:'Mon',time:'06:30',title:'Deep Study',duration:'2h',note:''},
  {id:'r3',day:'Mon',time:'09:00',title:'Extra Skill',duration:'1.5h',note:'Coding practice'},
  {id:'r4',day:'Mon',time:'12:00',title:'Lunch + Walk',duration:'1h',note:'Eat healthy'},
  {id:'r5',day:'Mon',time:'14:00',title:'Gym',duration:'2h',note:''},
  {id:'r6',day:'Mon',time:'17:00',title:'Violin + Japanese',duration:'1h',note:''},
  {id:'r7',day:'Mon',time:'20:00',title:'Review + Plan',duration:'30 min',note:'Daily debrief'},
];

// ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  generateStars();
  startClock();
  initCursor();
  const key = localStorage.getItem('nox_api_key');
  if (key) document.getElementById('api-key-inp').value = key;
});

// ‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  document.querySelector(`[onclick="switchAuthTab('${tab}')"]`).classList.add('active');
  document.getElementById(`form-${tab}`).classList.add('active');
  clearAuthError();
}

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg;
  el.classList.add('visible');
}

function clearAuthError() {
  document.getElementById('auth-error').classList.remove('visible');
}

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  if (!email || !pass) return showAuthError('Please fill in all fields');
  clearAuthError();
  try {
    const { auth, signInWithEmailAndPassword } = window._fb;
    await signInWithEmailAndPassword(auth, email, pass);
  } catch(e) {
    showAuthError(friendlyAuthError(e.code));
  }
}

async function doRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const refCode = document.getElementById('reg-ref').value.trim().toUpperCase();

  if (!name || !email || !pass) return showAuthError('Please fill in all fields');
  if (pass.length < 6) return showAuthError('Password must be at least 6 characters');
  clearAuthError();

  try {
    const { auth, db, createUserWithEmailAndPassword, updateProfile, doc, setDoc, getDocs, collection, query, where, updateDoc } = window._fb;
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });

    const code = generateRefCode();
    let bonusPts = 0;

    // Process referral code
    if (refCode) {
      const q = query(collection(db, 'users'), where('referralCode','==',refCode));
      const snap = await getDocs(q);
      if (!snap.empty) {
        const referrerDoc = snap.docs[0];
        await updateDoc(doc(db, 'users', referrerDoc.id), {
          points: (referrerDoc.data().points || 0) + 50,
          totalPoints: (referrerDoc.data().totalPoints || 0) + 50,
          referrals: [...(referrerDoc.data().referrals || []), cred.user.uid]
        });
        bonusPts = 50;
      }
    }

    const now = new Date().toISOString();
    await setDoc(doc(db, 'users', cred.user.uid), {
      ...state,
      points: bonusPts,
      totalPoints: bonusPts,
      profile: { displayName: name, avatar: 'üî•', email },
      referralCode: code,
      createdAt: now,
      goals: DEFAULT_GOALS,
      shopItems: DEFAULT_SHOP,
      routine: DEFAULT_ROUTINE,
      achievements: DEFAULT_ACHIEVEMENTS,
      completedToday: [],
      weeklyRedemptions: {},
      lastCheckIn: todayKey(),
    });

  } catch(e) {
    showAuthError(friendlyAuthError(e.code));
  }
}

function friendlyAuthError(code) {
  const map = {
    'auth/user-not-found': 'No account found with that email',
    'auth/wrong-password': 'Incorrect password',
    'auth/email-already-in-use': 'An account already exists with that email',
    'auth/invalid-email': 'Invalid email address',
    'auth/weak-password': 'Password is too weak',
    'auth/too-many-requests': 'Too many attempts. Try again later',
    'auth/network-request-failed': 'Network error ‚Äî check your connection',
  };
  return map[code] || 'An error occurred. Please try again';
}

async function doLogout() {
  const { auth, signOut } = window._fb;
  stopPet();
  await signOut(auth);
}

function showApp() {
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.add('visible');
  renderAll();
  startPet();
  setupNotifications();
}

function showAuth() {
  document.getElementById('auth-screen').classList.remove('hidden');
  document.getElementById('app').classList.remove('visible');
  document.getElementById('app').classList.remove('visible');
}

function generateRefCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = 'NOX-';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

// ‚ïê‚ïê‚ïê‚ïê FIREBASE DATA ‚ïê‚ïê‚ïê‚ïê
async function loadUserData(uid) {
  const { db, doc, getDoc, onSnapshot } = window._fb;
  const ref = doc(db, 'users', uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const data = snap.data();
    state = { ...state, ...data };
    if (!state.completedToday) state.completedToday = [];
    checkDailyReset();
    checkWeeklyReset();
    checkStreakRewards();
  }

  if (unsubscribe) unsubscribe();
  unsubscribe = onSnapshot(ref, (s) => {
    if (s.exists()) {
      state = { ...state, ...s.data() };
      if (!state.completedToday) state.completedToday = [];
      renderAll();
      updatePetDisplay();
    }
  });
}

async function save() {
  localStorage.setItem('nox_local', JSON.stringify(state));
  if (!currentUser || !window._fb) return;
  const { db, doc, setDoc } = window._fb;
  try {
    await setDoc(doc(db, 'users', currentUser.uid), state, { merge: true });
  } catch(e) { console.log('Save error:', e); }
}

// ‚ïê‚ïê‚ïê‚ïê RESETS ‚ïê‚ïê‚ïê‚ïê
function todayKey() { return new Date().toISOString().slice(0,10); }
function weekKey() {
  const d = new Date(), day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff)).toISOString().slice(0,10);
}

function checkDailyReset() {
  const today = todayKey();
  if (state.lastCheckIn !== today) {
    // Check if yesterday was completed (for streak)
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yKey = yesterday.toISOString().slice(0,10);
    if (state.lastCheckIn === yKey && state.completedToday.length > 0) {
      state.streak = (state.streak || 0) + 1;
      if (state.streak > (state.bestStreak || 0)) state.bestStreak = state.streak;
      checkStreakRewards();
    } else if (state.lastCheckIn !== today) {
      state.streak = 0;
    }
    state.points = 0;
    state.completedToday = [];
    state.lastCheckIn = today;
    // Decrease pet happiness slightly each day
    if (state.pet) state.pet.happiness = Math.max(10, (state.pet.happiness || 80) - 5);
    save();
  }
}

function checkWeeklyReset() {
  const wk = weekKey();
  if (state.lastWeekReset !== wk) {
    state.weeklyRedemptions = {};
    state.lastWeekReset = wk;
    save();
  }
}

function checkStreakRewards() {
  const streak = state.streak || 0;
  if (streak > 0 && streak % 10 === 0) {
    const bonus = Math.floor(streak / 10) * 10;
    state.points = Math.min(state.points + bonus, 999);
    state.totalPoints = (state.totalPoints || 0) + bonus;
    toast(`üî• ${streak}-day streak! +${bonus} bonus pts`, 'pet');
  }
  // Update pet stage
  if (state.pet) {
    let stageIdx = 0;
    for (let i = PET_STAGES.length - 1; i >= 0; i--) {
      if (streak >= PET_STAGES[i].threshold) { stageIdx = i; break; }
    }
    state.pet.stage = stageIdx;
  }
}

// ‚ïê‚ïê‚ïê‚ïê RENDER ALL ‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  updateSidebar();
  updateTopBar();
  renderGoals();
  renderShop();
  renderRoutine();
  renderAchievements();
  renderCustomizeGoals();
  renderCustomizeShop();
  renderProfile();
  renderSocial();
  updateStreakDisplay();
  updatePetDisplay();
  document.getElementById('thr-inp').value = state.threshold;
  document.getElementById('my-ref-code').textContent = state.referralCode || '‚Äî';
  const link = `${location.origin}${location.pathname}?ref=${state.referralCode}`;
  document.getElementById('ref-link-display').textContent = link;
  // Check achievements
  checkAchievements();
}

function updateSidebar() {
  document.getElementById('sb-pts').textContent = state.points;
}

function updateTopBar() {
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'morning' : hour < 17 ? 'afternoon' : 'evening';
  document.getElementById('greeting-time').textContent = greeting;
  document.getElementById('greeting-name').textContent = state.profile?.displayName || 'Warrior';
  document.getElementById('tb-streak').textContent = `${state.streak || 0}üî•`;
  document.getElementById('tb-pts').textContent = state.points;
}

// ‚ïê‚ïê‚ïê‚ïê GOALS ‚ïê‚ïê‚ïê‚ïê
function renderGoals() {
  const c = document.getElementById('goals-container');
  if (!c) return;
  if (!state.goals?.length) {
    c.innerHTML = `<div class="empty-s" style="grid-column:1/-1"><span class="es-icon">‚ú¶</span><h3>No goals yet</h3><p>Add goals in Customize</p></div>`;
    return;
  }

  const pts = state.goals.filter(g => state.completedToday.includes(g.id)).reduce((s,g) => s + g.points, 0);
  const capped = Math.min(100, pts);
  const pct = (capped / 100) * 100;

  document.getElementById('pb-earned').textContent = capped;
  document.getElementById('pb-bar').style.width = pct + '%';
  document.getElementById('pb-done').textContent = `${state.completedToday.length}/${state.goals.length}`;
  const pill = document.getElementById('unlock-pill');
  const needEl = document.getElementById('need-pts');
  if (capped >= state.threshold) {
    pill.textContent = '‚ú¶ Shop Open';
    pill.classList.add('open');
  } else {
    needEl.textContent = state.threshold - capped;
    pill.classList.remove('open');
  }

  const cats = {};
  state.goals.forEach(g => { if(!cats[g.category]) cats[g.category]=[]; cats[g.category].push(g); });

  c.innerHTML = Object.entries(cats).flatMap(([,goals]) =>
    goals.map(g => {
      const done = state.completedToday.includes(g.id);
      return `<div class="goal-card ${done?'done':''}" onclick="toggleGoal('${g.id}')">
        <div class="goal-cb">${done?'‚úì':''}</div>
        <div><div class="goal-name">${g.name}</div><div class="goal-meta">${g.category}${g.note?' ¬∑ '+g.note:''}</div></div>
        <div class="goal-pts-badge">+${g.points}</div>
      </div>`;
    })
  ).join('');
}

function toggleGoal(id) {
  const g = state.goals.find(x=>x.id===id);
  if (!g) return;
  if (state.completedToday.includes(id)) {
    state.completedToday = state.completedToday.filter(x=>x!==id);
    state.points = Math.max(0, state.points - g.points);
    toast(`‚àí${g.points} pts ‚Äî ${g.name} unchecked`, 'error');
  } else {
    state.completedToday.push(id);
    const gained = Math.min(100, state.points + g.points) - state.points;
    state.points = Math.min(100, state.points + g.points);
    state.totalPoints = (state.totalPoints||0) + gained;
    state.totalGoalsDone = (state.totalGoalsDone||0) + 1;
    floatPts(`+${gained}`, event);
    toast(`+${gained} pts ‚Äî ${g.name}`, 'success');
    animPts();
    // Pet reaction
    if (state.pet) {
      state.pet.happiness = Math.min(100, (state.pet.happiness||80) + 2);
      petSpeak(['Great work! üåü','Keep going!','You\'re crushing it!','Power up! ‚ö°'][Math.floor(Math.random()*4)]);
    }
  }
  save();
  renderGoals();
  renderShop();
  updateSidebar();
  updateTopBar();
}

// ‚ïê‚ïê‚ïê‚ïê SHOP ‚ïê‚ïê‚ïê‚ïê
function renderShop() {
  const locked = document.getElementById('shop-locked');
  const open = document.getElementById('shop-open');
  const needEl = document.getElementById('shop-need');
  const unlocked = state.points >= state.threshold;

  if (locked) { locked.style.display = unlocked ? 'none' : 'flex'; needEl.textContent = state.threshold - state.points; }
  if (open) open.className = 'shop-unlocked-banner' + (unlocked ? ' show' : '');

  const c = document.getElementById('shop-container');
  if (!c) return;
  if (!state.shopItems?.length) { c.innerHTML = '<div class="empty-s"><span class="es-icon">‚óà</span><h3>Shop is empty</h3></div>'; return; }

  const cats = {};
  state.shopItems.forEach(i => { if(!cats[i.category]) cats[i.category]=[]; cats[i.category].push(i); });

  c.innerHTML = Object.entries(cats).map(([cat,items]) => `
    <div style="margin-bottom:28px">
      <div class="shop-cat-label">${cat}</div>
      <div class="shop-grid">
        ${items.map(item => {
          const rem = 2 - (state.weeklyRedemptions[item.id]||0);
          const depleted = rem <= 0;
          const canBuy = unlocked && !depleted && state.points >= item.cost;
          return `<div class="shop-card ${depleted?'depleted':''}">
            <div class="shop-icon">${item.icon||'‚ú¶'}</div>
            <div class="shop-name">${item.name}</div>
            <div class="shop-desc">${item.desc||''}</div>
            <div class="shop-footer">
              <span class="shop-cost">${item.cost} pts</span>
              <span class="shop-uses ${rem===1?'warn':''}">${rem} left</span>
            </div>
            <button class="redeem-btn" ${canBuy?'':'disabled'} onclick="redeemItem('${item.id}',event)">
              ${depleted?'‚úï Used up':!unlocked?'üîí Locked':state.points<item.cost?'Need more pts':'Redeem ‚Üí'}
            </button>
          </div>`;
        }).join('')}
      </div>
    </div>`).join('');
}

function redeemItem(id, e) {
  const item = state.shopItems.find(i=>i.id===id);
  if (!item) return;
  if (state.points < state.threshold) { toast('Reach your threshold first!','error'); return; }
  if ((state.weeklyRedemptions[id]||0) >= 2) { toast('Weekly limit reached!','error'); return; }
  if (state.points < item.cost) { toast('Not enough points!','error'); return; }
  state.points -= item.cost;
  state.weeklyRedemptions[id] = (state.weeklyRedemptions[id]||0) + 1;
  floatPts(`‚àí${item.cost}`, e, true);
  toast(`${item.icon} Redeemed: ${item.name}`, 'success');
  save(); renderAll();
}

// ‚ïê‚ïê‚ïê‚ïê ROUTINE ‚ïê‚ïê‚ïê‚ïê
function renderRoutine() {
  const c = document.getElementById('routine-container');
  if (!c) return;
  const blocks = (state.routine||[]).filter(r=>r.day===state.currentDay).sort((a,b)=>a.time.localeCompare(b.time));
  if (!blocks.length) { c.innerHTML='<div class="empty-s"><span class="es-icon">‚ó∑</span><h3>No blocks for '+state.currentDay+'</h3></div>'; return; }
  c.innerHTML = blocks.map(b => `
    <div class="tl-item">
      <span class="tl-time">${b.time}</span>
      <span class="tl-dot"></span>
      <div class="tl-card">
        <div style="flex:1"><div class="tc-name">${b.title}</div><div class="tc-note">${b.note||''}</div></div>
        <span class="tc-dur">${b.duration}</span>
        <button class="icon-btn" onclick="openModal('edit-routine','${b.id}')">‚úé</button>
        <button class="icon-btn del" onclick="deleteRoutine('${b.id}')">‚úï</button>
      </div>
    </div>`).join('');
}

function setDay(day, el) {
  state.currentDay = day;
  document.querySelectorAll('.day-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderRoutine();
}

// ‚ïê‚ïê‚ïê‚ïê STREAK ‚ïê‚ïê‚ïê‚ïê
function updateStreakDisplay() {
  const streak = state.streak || 0;
  document.getElementById('streak-num').textContent = streak;
  const cal = document.getElementById('streak-cal');
  if (!cal) return;
  const days = Math.min(streak, 31);
  cal.innerHTML = Array.from({length:days},(_,i)=>{
    const pts = 100; // simplified
    const cls = pts >= 80 ? 'l3' : pts >= 60 ? 'l2' : 'l1';
    return `<div class="sc-dot ${cls}">${i+1}</div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê ACHIEVEMENTS ‚ïê‚ïê‚ïê‚ïê
function renderAchievements() {
  const c = document.getElementById('achievements-container');
  if (!c) return;
  const achs = state.achievements || DEFAULT_ACHIEVEMENTS;
  c.innerHTML = achs.map(a => `
    <div class="achievement-card ${a.earned?'earned':'locked'}">
      <span class="ach-icon">${a.icon}</span>
      <div class="ach-name">${a.name}</div>
      <div class="ach-desc">${a.desc}</div>
      <span class="ach-pts">+${a.pts} pts</span>
      ${!a.earned?'<div class="ach-locked-overlay">üîí</div>':''}
    </div>`).join('');
  document.getElementById('stat-ach').textContent = achs.filter(a=>a.earned).length;
}

function checkAchievements() {
  if (!state.achievements) state.achievements = [...DEFAULT_ACHIEVEMENTS];
  let changed = false;
  state.achievements.forEach(a => {
    if (a.earned) return;
    let unlocked = false;
    if (a.condition === 'goals_done>=1' && (state.totalGoalsDone||0) >= 1) unlocked = true;
    if (a.condition === 'daily_pts>=100' && state.points >= 100) unlocked = true;
    if (a.condition === 'streak>=7' && (state.streak||0) >= 7) unlocked = true;
    if (a.condition === 'streak>=30' && (state.streak||0) >= 30) unlocked = true;
    if (a.condition === 'referrals>=1' && (state.referrals||[]).length >= 1) unlocked = true;
    if (a.condition === 'pet_named' && state.pet?.name && state.pet.name !== 'Noxie') unlocked = true;
    if (a.condition === 'pet_stage>=6' && (state.pet?.stage||0) >= 6) unlocked = true;
    if (unlocked) {
      a.earned = true;
      state.points += a.pts;
      state.totalPoints = (state.totalPoints||0) + a.pts;
      toast(`üèÜ Achievement: ${a.name}! +${a.pts} pts`,'success');
      changed = true;
    }
  });
  if (changed) { save(); renderAchievements(); }
}

async function generateAchievements() {
  const key = localStorage.getItem('nox_api_key');
  if (!key) { toast('Add your API key in Customize first','error'); return; }

  const goalNames = (state.goals||[]).map(g=>g.name).join(', ');
  const c = document.getElementById('achievements-container');
  c.innerHTML = `<div class="empty-s"><div class="dot-loader"><span></span><span></span><span></span></div><h3 style="margin-top:16px">Generating...</h3></div>`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1200,
        system:`Create unique, personalized achievements for a productivity app called NOX. The user's goals are: ${goalNames}. Their current streak: ${state.streak}. Return EXACTLY 9 achievements as JSON array with fields: id,name,desc,icon(emoji),pts(number),earned(false),condition(string). Make them creative, specific to their goals, and progressively harder. Return ONLY the JSON array, no other text.`,
        messages:[{role:'user',content:'Generate my personalized achievements'}]
      })
    });
    const data = await res.json();
    const text = data.content[0].text.trim().replace(/```json|```/g,'');
    const achs = JSON.parse(text);
    state.achievements = achs;
    save();
    renderAchievements();
    toast('‚úß AI achievements generated!','success');
  } catch(e) {
    state.achievements = DEFAULT_ACHIEVEMENTS;
    renderAchievements();
    toast('Used default achievements','');
  }
}

// ‚ïê‚ïê‚ïê‚ïê PET SYSTEM ‚ïê‚ïê‚ïê‚ïê
function getPetStage() {
  const streak = state.streak || 0;
  let stage = 0;
  for (let i = PET_STAGES.length-1; i>=0; i--) {
    if (streak >= PET_STAGES[i].threshold) { stage = i; break; }
  }
  return stage;
}

function getPetEmoji() {
  if (state.pet?.customImage) return null;
  const type = state.pet?.type || 'cat';
  const stage = getPetStage();
  if (stage === 0) return 'ü•ö';
  return PET_EMOJIS[type] || 'üê±';
}

function renderPetSVG(svgEl, size=80) {
  const stage = getPetStage();
  const emoji = getPetEmoji();
  const stageInfo = PET_STAGES[stage];

  if (state.pet?.customImage) {
    svgEl.innerHTML = `
      <defs><clipPath id="petClip"><circle cx="${size/2}" cy="${size/2}" r="${size/2-2}"/></clipPath></defs>
      <image href="${state.pet.customImage}" x="0" y="0" width="${size}" height="${size}" clip-path="url(#petClip)"/>
      <circle cx="${size/2}" cy="${size/2}" r="${size/2-2}" fill="none" stroke="${'#C9A84C'}" stroke-width="2"/>`;
  } else if (stage === 0) {
    // Egg
    const s = size;
    svgEl.innerHTML = `
      <ellipse cx="${s/2}" cy="${s*0.55}" rx="${s*0.32}" ry="${s*0.38}" fill="#2A2040" stroke="#C9A84C" stroke-width="2"/>
      <ellipse cx="${s*0.42}" cy="${s*0.5}" rx="${s*0.05}" ry="${s*0.07}" fill="#4A3080" opacity="0.6"/>
      <ellipse cx="${s*0.58}" cy="${s*0.48}" rx="${s*0.04}" ry="${s*0.06}" fill="#4A3080" opacity="0.6"/>
      <path d="M${s*0.38},${s*0.65} Q${s*0.5},${s*0.7} ${s*0.62},${s*0.65}" stroke="#C9A84C" stroke-width="1.5" fill="none" opacity="0.6"/>`;
  } else {
    // Creature with emoji as base
    const s = size;
    const scale = 0.8 + (stage * 0.05);
    const emojiSize = Math.floor(s * scale * 0.7);
    svgEl.innerHTML = `
      <circle cx="${s/2}" cy="${s/2}" r="${s/2-4}" fill="#1A1A2E" opacity="0.4"/>
      <text x="${s/2}" y="${s*0.62}" font-size="${emojiSize}" text-anchor="middle" dominant-baseline="middle">${emoji}</text>
      <circle cx="${s*0.7}" cy="${s*0.25}" r="${s*0.08}" fill="#C9A84C" opacity="${Math.min(1, stage*0.2)}">
        <animate attributeName="opacity" values="${stage*0.2};${stage*0.4};${stage*0.2}" dur="2s" repeatCount="indefinite"/>
      </circle>`;
  }
}

function updatePetDisplay() {
  const stage = getPetStage();
  const stageInfo = PET_STAGES[stage];
  const streak = state.streak || 0;

  // Sidebar pet
  const petSvg = document.getElementById('pet-svg');
  if (petSvg) renderPetSVG(petSvg, 80);

  // Pet name tag
  const nameTag = document.getElementById('pet-name-tag');
  if (nameTag) nameTag.textContent = state.pet?.name || '?';

  // Pet view page
  const viewSvg = document.getElementById('pet-view-svg');
  if (viewSvg) renderPetSVG(viewSvg, 160);

  const stageBadge = document.getElementById('pet-stage-badge');
  if (stageBadge) stageBadge.textContent = stageInfo.name.toUpperCase();

  const nextStageEl = document.getElementById('pet-next-stage');
  if (nextStageEl) {
    const next = PET_STAGES[stage+1];
    nextStageEl.textContent = next ? `Next stage at ${next.threshold} streak days` : 'Maximum stage reached!';
  }

  const hap = state.pet?.happiness || 80;
  const hapEl = document.getElementById('pet-happiness');
  if (hapEl) hapEl.style.width = hap + '%';
  const hapNum = document.getElementById('pet-hap-num');
  if (hapNum) hapNum.textContent = hap + '%';

  document.getElementById('pet-name-disp').textContent = state.pet?.name || 'Unnamed';
  document.getElementById('pet-stage-txt').textContent = stageInfo.name;

  const next = PET_STAGES[stage+1];
  document.getElementById('pet-next-txt').textContent = next ? `${next.threshold - streak} more streak days` : 'Max stage!';

  const nextBonus = Math.ceil(streak/10)*10;
  document.getElementById('pet-bonus-txt').textContent = `+${(Math.floor(streak/10)+1)*10} pts at day ${nextBonus}`;

  // Update chooser selection
  document.querySelectorAll('.pet-choice').forEach(p => {
    p.classList.toggle('selected', p.dataset.type === (state.pet?.type||'cat'));
  });
}

function startPet() {
  const container = document.getElementById('pet-container');
  petX = 100; petY = window.innerHeight - 120;
  container.style.left = petX + 'px';
  container.style.top = petY + 'px';
  container.style.display = 'block';

  // Pet wanders around
  petRunInterval = setInterval(() => {
    petX += petDX * 1.5;
    petY += petDY * 0.5;
    // Bounce
    if (petX < 80 || petX > window.innerWidth - 150) petDX *= -1;
    if (petY < window.innerHeight * 0.6 || petY > window.innerHeight - 100) petDY *= -1;
    // Random direction change
    if (Math.random() < 0.01) { petDX *= -1; petDY = (Math.random()-0.5)*2; }
    container.style.left = petX + 'px';
    container.style.top = petY + 'px';
    // Flip pet if moving left
    const svg = container.querySelector('.pet-svg');
    if (svg) svg.style.transform = petDX < 0 ? 'scaleX(-1)' : 'scaleX(1)';
  }, 50);

  // Occasional speech
  setInterval(() => {
    const msgs = ['Feed me! üçñ','I miss you!','Keep going!','Streak power! üî•','You got this!','Psst... shop is open?','Work hard! üí™'];
    if (Math.random() < 0.3) petSpeak(msgs[Math.floor(Math.random()*msgs.length)]);
  }, 30000);
}

function stopPet() {
  if (petRunInterval) clearInterval(petRunInterval);
  document.getElementById('pet-container').style.display = 'none';
}

function petSpeak(msg) {
  const el = document.getElementById('pet-speech');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'), 2500);
}

function openPetInteract() {
  // Quick pet interaction from sidebar click
  nav('pet');
}

function petAction(action) {
  const costs = { feed:5, pet:3, play:8 };
  const cost = costs[action];
  if (state.points < cost) { toast('Not enough points!','error'); return; }
  state.points -= cost;
  state.pet.happiness = Math.min(100, (state.pet.happiness||80) + (action==='play'?15:action==='feed'?10:8));

  const reactions = {
    feed: ['Yum! üòã','So tasty!','More please!'],
    pet: ['Purrr... üíï','So nice!','I love you!'],
    play: ['Yay! ‚öΩ','So fun!','Again! Again!']
  };

  petSpeak(reactions[action][Math.floor(Math.random()*3)]);

  // Show hearts
  const container = document.getElementById('pet-container');
  for (let i=0; i<4; i++) {
    const heart = document.createElement('div');
    heart.className = 'heart-particle';
    heart.textContent = ['‚ù§Ô∏è','üíõ','‚ú®','‚≠ê'][i];
    heart.style.left = (Math.random()*60)+'px';
    heart.style.top = '20px';
    container.appendChild(heart);
    setTimeout(()=>heart.remove(), 1200);
  }

  floatPts(`‚àí${cost}`, null, true);
  save(); renderAll();
  toast(`${action==='feed'?'üçñ':'ü§≤'} Pet is happy! +${action==='play'?15:action==='feed'?10:8}% happiness`, 'pet');
}

function choosePet(type) {
  if (type === 'custom') {
    document.getElementById('pet-upload').click();
    return;
  }
  state.pet.type = type;
  state.pet.customImage = null;
  save(); updatePetDisplay();
  toast(`Pet changed to ${PET_EMOJIS[type]}`, 'pet');
}

function uploadPetImage(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    state.pet.customImage = e.target.result;
    state.pet.type = 'custom';
    save(); updatePetDisplay();
    toast('Custom pet uploaded! üé®', 'pet');
  };
  reader.readAsDataURL(file);
}

function renamePet() {
  const name = prompt('Name your companion:', state.pet?.name || 'Noxie');
  if (name && name.trim()) {
    state.pet.name = name.trim().slice(0,20);
    save(); updatePetDisplay();
    toast(`Pet renamed to "${state.pet.name}"! üêæ`, 'pet');
    petSpeak(`My name is ${state.pet.name}! üåü`);
    checkAchievements();
  }
}

// ‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê
function renderProfile() {
  const p = state.profile || {};
  document.getElementById('profile-name').textContent = p.displayName || currentUser?.displayName || 'Warrior';
  document.getElementById('profile-email').textContent = p.email || currentUser?.email || '';
  document.getElementById('profile-avatar').textContent = p.avatar || 'üî•';
  document.getElementById('edit-name').value = p.displayName || '';
  document.getElementById('edit-avatar').value = p.avatar || 'üî•';

  const since = currentUser?.metadata?.creationTime;
  document.getElementById('profile-since').textContent = since ? 'Member since ' + new Date(since).toLocaleDateString('en-US',{month:'long',year:'numeric'}) : '';

  document.getElementById('stat-streak').textContent = state.streak || 0;
  document.getElementById('stat-total-pts').textContent = state.totalPoints || 0;
  document.getElementById('stat-goals-done').textContent = state.totalGoalsDone || 0;
  document.getElementById('stat-best-streak').textContent = state.bestStreak || 0;
  document.getElementById('stat-referrals').textContent = (state.referrals||[]).length;

  // Notif settings
  const ns = state.notifSettings || {};
  document.getElementById('notif-daily').checked = ns.daily||false;
  document.getElementById('notif-streak').checked = ns.streak||false;
  document.getElementById('notif-reset').checked = ns.reset||false;
}

function saveProfile() {
  const name = document.getElementById('edit-name').value.trim();
  const avatar = document.getElementById('edit-avatar').value.trim() || 'üî•';
  if (!name) return toast('Enter a display name','error');
  if (!state.profile) state.profile = {};
  state.profile.displayName = name;
  state.profile.avatar = avatar;
  state.profile.email = currentUser?.email || '';
  save(); renderAll();
  toast('Profile saved ‚úì','success');
}

function saveNotifSettings() {
  state.notifSettings = {
    daily: document.getElementById('notif-daily').checked,
    streak: document.getElementById('notif-streak').checked,
    reset: document.getElementById('notif-reset').checked,
  };
  save();
}

// ‚ïê‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê‚ïê
async function requestNotifPermission() {
  if (!('Notification' in window)) { toast('Notifications not supported in this browser','error'); return; }
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    toast('Notifications enabled! üîî','success');
    setupNotifications();
  } else {
    toast('Notification permission denied','error');
  }
}

function setupNotifications() {
  if (Notification.permission !== 'granted') return;
  const ns = state.notifSettings || {};

  // Daily reminder at 9am
  if (ns.daily) scheduleNotif('üåÖ NOX Daily Mission', 'Your goals are waiting. Start earning your indulgence.', 9, 0);
  // Streak reminder at 8pm
  if (ns.streak) scheduleNotif('üî• Streak Alert', `You\'re on a ${state.streak}-day streak! Don\'t break it tonight.`, 20, 0);
}

function scheduleNotif(title, body, hour, minute) {
  const now = new Date();
  let target = new Date();
  target.setHours(hour, minute, 0, 0);
  if (target <= now) target.setDate(target.getDate() + 1);
  const ms = target - now;
  setTimeout(() => {
    new Notification(title, { body, icon: 'üåë', badge: 'üåë' });
    scheduleNotif(title, body, hour, minute); // reschedule daily
  }, ms);
}

function toggleNotifPanel() {
  nav('profile');
}

// ‚ïê‚ïê‚ïê‚ïê SOCIAL ‚ïê‚ïê‚ïê‚ïê
function renderSocial() {
  document.getElementById('my-ref-code').textContent = state.referralCode || '‚Äî';
  const link = `${location.origin}${location.pathname}?ref=${state.referralCode}`;
  document.getElementById('ref-link-display').textContent = link;
  renderLeaderboard();
}

function copyRefCode() {
  navigator.clipboard.writeText(state.referralCode || '');
  toast('Referral code copied!','success');
}

function shareRefLink() {
  const link = `${location.origin}${location.pathname}?ref=${state.referralCode}`;
  if (navigator.share) {
    navigator.share({ title:'Join me on NOX', text:'Earn your indulgence with me!', url:link });
  } else {
    navigator.clipboard.writeText(link);
    toast('Invite link copied!','success');
  }
}

async function renderLeaderboard() {
  const c = document.getElementById('leaderboard-list');
  if (!c || !window._fb) return;
  try {
    const { db, collection, query, orderBy, limit, getDocs } = window._fb;
    const q = query(collection(db,'users'), orderBy('totalPoints','desc'), limit(10));
    const snap = await getDocs(q);
    const entries = snap.docs.map((d,i) => ({...d.data(), uid:d.id, rank:i+1}));
    c.innerHTML = entries.map(e => `
      <div class="friend-item">
        <div class="friend-avatar">${e.profile?.avatar||'üî•'}</div>
        <span class="friend-name">${e.rank}. ${e.profile?.displayName||'Warrior'}${e.uid===currentUser?.uid?' (you)':''}</span>
        <span class="friend-pts">${e.totalPoints||0} pts</span>
      </div>`).join('') || '<div class="empty-s" style="padding:20px">No data yet</div>';
  } catch(e) {
    c.innerHTML = '<div class="empty-s" style="padding:20px;font-size:12px">Set up Firebase to see leaderboard</div>';
  }
}

// ‚ïê‚ïê‚ïê‚ïê AI THEME ‚ïê‚ïê‚ïê‚ïê
function aiThemePrompt(prompt) {
  document.getElementById('theme-prompt').value = prompt;
}

async function generateTheme() {
  const key = localStorage.getItem('nox_api_key');
  if (!key) { toast('Add API key first','error'); nav('customize'); return; }
  const prompt = document.getElementById('theme-prompt').value.trim();
  if (!prompt) { toast('Describe your aesthetic','error'); return; }

  const respEl = document.getElementById('theme-resp');
  respEl.className = 'ai-resp show';
  respEl.innerHTML = `<div class="ai-loader-row"><div class="dot-loader"><span></span><span></span><span></span></div> Generating your theme...</div>`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:800,
        system:`You are a UI designer generating CSS color themes. Given a description, create a dark theme with these EXACT CSS variable names. Return ONLY a JSON object (no markdown) with keys matching these CSS vars: void(darkest bg), abyss(dark bg), deep, surface, panel, raised, gold(primary accent), gold-dim, gold-bright, ember(warning/red), jade(success/green), rose(error/pink), sky(info/blue), text(primary text), text-mid, text-dim, border-color. All values must be valid CSS colors. Keep backgrounds very dark (dark mode). Make accents vivid and thematic.`,
        messages:[{role:'user',content:`Theme description: ${prompt}`}]
      })
    });
    const data = await res.json();
    const text = data.content[0].text.trim().replace(/```json|```/g,'');
    const colors = JSON.parse(text);
    applyTheme(colors);
    state.theme = colors;
    save();
    respEl.innerHTML = `‚úì Theme applied! <em style="color:var(--text-dim)">${prompt}</em><br><br>${Object.entries(colors).map(([k,v])=>`<span style="display:inline-block;width:12px;height:12px;background:${v};border-radius:2px;margin-right:4px;vertical-align:middle"></span>${k}: ${v}`).join('<br>')}`;
    toast('‚úß Theme applied!','success');
  } catch(e) {
    respEl.innerHTML = `<span style="color:var(--rose)">Error: ${e.message}. Check your API key.</span>`;
  }
}

function applyTheme(colors) {
  const root = document.documentElement;
  Object.entries(colors).forEach(([k,v]) => {
    root.style.setProperty(`--${k}`, v);
    if (k === 'border-color') root.style.setProperty('--border', v);
  });
}

function resetTheme() {
  const root = document.documentElement;
  ['void','abyss','deep','surface','panel','raised','gold','gold-dim','gold-bright','ember','jade','rose','sky','text','text-mid','text-dim','border'].forEach(k => root.style.removeProperty('--'+k));
  state.theme = null;
  save();
  toast('Theme reset to NOX default','');
}

// Apply saved theme on load
function applySavedTheme() {
  if (state.theme) applyTheme(state.theme);
}

// ‚ïê‚ïê‚ïê‚ïê CUSTOMIZE ‚ïê‚ïê‚ïê‚ïê
function renderCustomizeGoals() {
  const c = document.getElementById('cust-goals');
  if (!c) return;
  c.innerHTML = (state.goals||[]).map(g => `
    <div style="display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border)">
      <span style="flex:1;font-size:14px">${g.name}</span>
      <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--gold)">+${g.points}</span>
      <button class="icon-btn" onclick="openModal('edit-goal','${g.id}')">‚úé</button>
      <button class="icon-btn del" onclick="deleteGoal('${g.id}')">‚úï</button>
    </div>`).join('') || '<div style="padding:16px;color:var(--text-dim);font-size:13px">No goals yet</div>';
}

function renderCustomizeShop() {
  const c = document.getElementById('cust-shop');
  if (!c) return;
  c.innerHTML = (state.shopItems||[]).map(i => `
    <div style="display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border)">
      <span style="font-size:18px">${i.icon||'‚ú¶'}</span>
      <span style="flex:1;font-size:14px">${i.name}</span>
      <span style="font-family:'DM Mono',monospace;font-size:11px;color:var(--rose)">‚àí${i.cost}</span>
      <button class="icon-btn" onclick="openModal('edit-shop','${i.id}')">‚úé</button>
      <button class="icon-btn del" onclick="deleteShopItem('${i.id}')">‚úï</button>
    </div>`).join('') || '<div style="padding:16px;color:var(--text-dim);font-size:13px">No items yet</div>';
}

function saveThreshold() {
  const val = parseInt(document.getElementById('thr-inp').value);
  if (isNaN(val)||val<0||val>100){toast('Enter 0‚Äì100','error');return;}
  state.threshold = val;
  save(); renderAll();
  toast(`Threshold set to ${val} pts`,'success');
}

// ‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê
function openModal(type, id) {
  const body = document.getElementById('modal-body');
  const overlay = document.getElementById('overlay');

  const icons = ['üéÆ','üì∫','üéµ','üçï','üõçÔ∏è','üéå','‚öîÔ∏è','üìñ','üë•','üì±','üåô','‚òÄÔ∏è','üéØ','‚ú®','üéÇ','üèñÔ∏è','‚öΩ','üé™','üçø','üé¨'];

  if (type === 'add-goal' || type === 'edit-goal') {
    const g = id ? state.goals?.find(x=>x.id===id) : null;
    body.innerHTML = `
      <div class="modal-title">${g?'Edit':'New'} Goal</div>
      <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="m-name" value="${g?.name||''}" placeholder="e.g. Study session"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group"><label class="form-label">Points</label><input class="form-input" id="m-pts" type="number" min="1" max="100" value="${g?.points||10}"></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-input" id="m-cat">${['Core','Health','Skills','Other'].map(c=>`<option ${g?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Note (optional)</label><input class="form-input" id="m-note" value="${g?.note||''}" placeholder="Short description"></div>
      <div class="modal-actions"><button class="btn-ghost" onclick="closeModal()">Cancel</button><button class="btn-primary" onclick="saveGoal('${id||''}')">Save</button></div>`;

  } else if (type === 'add-shop' || type === 'edit-shop') {
    const item = id ? state.shopItems?.find(x=>x.id===id) : null;
    body.innerHTML = `
      <div class="modal-title">${item?'Edit':'New'} Shop Item</div>
      <div class="form-group"><label class="form-label">Name</label><input class="form-input" id="m-name" value="${item?.name||''}" placeholder="e.g. Movie night"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group"><label class="form-label">Cost (pts)</label><input class="form-input" id="m-pts" type="number" min="1" value="${item?.cost||30}"></div>
        <div class="form-group"><label class="form-label">Category</label><select class="form-input" id="m-cat">${['Entertainment','Control','Indulgence','Other'].map(c=>`<option ${item?.category===c?'selected':''}>${c}</option>`).join('')}</select></div>
      </div>
      <div class="form-group"><label class="form-label">Description</label><input class="form-input" id="m-desc" value="${item?.desc||''}" placeholder="Short description"></div>
      <div class="form-group"><label class="form-label">Icon</label>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:4px" id="icon-pick">
          ${icons.map(ic=>`<span style="cursor:pointer;font-size:22px;padding:4px;border-radius:6px;border:1.5px solid ${item?.icon===ic?'var(--gold)':'var(--border)'};background:${item?.icon===ic?'rgba(201,168,76,0.1)':'transparent'}" onclick="pickIcon(this,'${ic}')">${ic}</span>`).join('')}
        </div>
        <input type="hidden" id="m-icon" value="${item?.icon||'‚ú¶'}">
      </div>
      <div class="modal-actions"><button class="btn-ghost" onclick="closeModal()">Cancel</button><button class="btn-primary" onclick="saveShopItem('${id||''}')">Save</button></div>`;

  } else if (type === 'add-routine' || type === 'edit-routine') {
    const b = id ? state.routine?.find(x=>x.id===id) : null;
    body.innerHTML = `
      <div class="modal-title">${b?'Edit':'New'} Routine Block</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group"><label class="form-label">Day</label><select class="form-input" id="m-day">${DAYS.map(d=>`<option ${(b?b.day===d:d===state.currentDay)?'selected':''}>${d}</option>`).join('')}</select></div>
        <div class="form-group"><label class="form-label">Time</label><input class="form-input" id="m-time" type="time" value="${b?.time||'08:00'}"></div>
      </div>
      <div class="form-group"><label class="form-label">Activity</label><input class="form-input" id="m-name" value="${b?.title||''}" placeholder="e.g. Deep Work"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
        <div class="form-group"><label class="form-label">Duration</label><input class="form-input" id="m-dur" value="${b?.duration||'1h'}" placeholder="1h"></div>
        <div class="form-group"><label class="form-label">Note</label><input class="form-input" id="m-note" value="${b?.note||''}" placeholder="Optional"></div>
      </div>
      <div class="modal-actions"><button class="btn-ghost" onclick="closeModal()">Cancel</button><button class="btn-primary" onclick="saveRoutineBlock('${id||''}')">Save</button></div>`;

  } else if (type === 'invite') {
    body.innerHTML = `
      <div class="modal-title">Invite a Friend</div>
      <div class="form-group"><label class="form-label">Share your code or link</label>
        <div style="display:flex;gap:8px"><input class="form-input" value="${state.referralCode}" readonly style="font-family:'DM Mono',monospace"><button class="btn-primary" onclick="copyRefCode()">Copy</button></div>
      </div>
      <div style="font-size:14px;color:var(--text-dim);line-height:1.7">When your friend registers using your code, you both get <strong style="color:var(--gold)">+50 bonus points</strong>!</div>
      <div class="modal-actions"><button class="btn-ghost" onclick="closeModal()">Close</button></div>`;
  }

  overlay.classList.add('open');
}

function pickIcon(el, icon) {
  document.querySelectorAll('#icon-pick span').forEach(s=>{s.style.borderColor='var(--border)';s.style.background='transparent'});
  el.style.borderColor='var(--gold)'; el.style.background='rgba(201,168,76,0.1)';
  document.getElementById('m-icon').value=icon;
}

function closeModal() { document.getElementById('overlay').classList.remove('open'); }
function closeOverlay(e) { if(e.target===document.getElementById('overlay')) closeModal(); }

function uid() { return '_'+Math.random().toString(36).slice(2,10); }

function saveGoal(id) {
  const name=document.getElementById('m-name').value.trim();
  const pts=parseInt(document.getElementById('m-pts').value)||10;
  const cat=document.getElementById('m-cat').value;
  const note=document.getElementById('m-note').value.trim();
  if(!name){toast('Name required','error');return;}
  if(!state.goals) state.goals=[];
  if(id){const i=state.goals.findIndex(g=>g.id===id);if(i!==-1)state.goals[i]={...state.goals[i],name,points:pts,category:cat,note};}
  else state.goals.push({id:uid(),name,points:pts,category:cat,note});
  save();renderAll();closeModal();
  toast(`Goal "${name}" saved`,'success');
}

function saveShopItem(id) {
  const name=document.getElementById('m-name').value.trim();
  const cost=parseInt(document.getElementById('m-pts').value)||20;
  const cat=document.getElementById('m-cat').value;
  const desc=document.getElementById('m-desc').value.trim();
  const icon=document.getElementById('m-icon').value;
  if(!name){toast('Name required','error');return;}
  if(!state.shopItems) state.shopItems=[];
  if(id){const i=state.shopItems.findIndex(x=>x.id===id);if(i!==-1)state.shopItems[i]={...state.shopItems[i],name,cost,category:cat,desc,icon};}
  else state.shopItems.push({id:uid(),name,cost,category:cat,desc,icon});
  save();renderAll();closeModal();
  toast(`Shop item "${name}" saved`,'success');
}

function saveRoutineBlock(id) {
  const day=document.getElementById('m-day').value;
  const time=document.getElementById('m-time').value;
  const title=document.getElementById('m-name').value.trim();
  const duration=document.getElementById('m-dur').value.trim();
  const note=document.getElementById('m-note').value.trim();
  if(!title){toast('Name required','error');return;}
  if(!state.routine) state.routine=[];
  if(id){const i=state.routine.findIndex(r=>r.id===id);if(i!==-1)state.routine[i]={...state.routine[i],day,time,title,duration,note};}
  else state.routine.push({id:uid(),day,time,title,duration,note});
  state.currentDay=day;
  document.querySelectorAll('.day-tab').forEach(t=>t.classList.toggle('active',t.dataset.day===day));
  save();renderAll();closeModal();
  toast(`Block "${title}" saved`,'success');
}

function deleteGoal(id) {
  if(!confirm('Delete this goal?')) return;
  state.goals=state.goals.filter(g=>g.id!==id);
  state.completedToday=(state.completedToday||[]).filter(x=>x!==id);
  save();renderAll();toast('Goal deleted','');
}

function deleteShopItem(id) {
  if(!confirm('Delete this item?')) return;
  state.shopItems=state.shopItems.filter(i=>i.id!==id);
  save();renderAll();toast('Shop item deleted','');
}

function deleteRoutine(id) {
  state.routine=state.routine.filter(r=>r.id!==id);
  save();renderAll();toast('Block deleted','');
}

// ‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê
function nav(view) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
  if(view==='routine') renderRoutine();
  if(view==='achievements') renderAchievements();
  if(view==='social') renderSocial();
  if(view==='profile') renderProfile();
  if(view==='pet') updatePetDisplay();
}

// ‚ïê‚ïê‚ïê‚ïê API KEY ‚ïê‚ïê‚ïê‚ïê
function saveApiKey() {
  const key = document.getElementById('api-key-inp').value.trim();
  if(!key){toast('Enter an API key','error');return;}
  localStorage.setItem('nox_api_key',key);
  toast('API key saved ‚úì','success');
}

// ‚ïê‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê
function animPts() {
  const el=document.getElementById('pb-earned');
  if(el){el.classList.remove('flash');void el.offsetWidth;el.classList.add('flash');}
  const sb=document.getElementById('sb-pts');
  if(sb){sb.classList.remove('flash');void sb.offsetWidth;sb.classList.add('flash');}
}

function floatPts(text, e, negative=false) {
  const el=document.createElement('div');
  el.className='pt-float';
  el.textContent=text;
  el.style.color=negative?'var(--rose)':'var(--gold-bright)';
  if(e&&e.clientX){el.style.left=(e.clientX-20)+'px';el.style.top=(e.clientY-20)+'px';}
  else{el.style.left='50%';el.style.top='40%';}
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}

function toast(msg, type='') {
  const c=document.getElementById('toasts');
  const t=document.createElement('div');
  t.className=`toast ${type}`;
  const icons={success:'‚úì',error:'‚úï',pet:'üêæ','':'‚óà'};
  t.innerHTML=`<span>${icons[type]||'‚óà'}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),400);},2800);
}

function checkRefCode() {
  const val = document.getElementById('reg-ref').value.trim();
  const badge = document.getElementById('ref-badge');
  badge.classList.toggle('visible', val.length >= 8);
}

// ‚ïê‚ïê‚ïê‚ïê CLOCK ‚ïê‚ïê‚ïê‚ïê
function startClock() {
  const update = () => {
    const now = new Date();
    const hour = now.getHours();
    // Every minute check for daily/weekly resets
    if (now.getSeconds() < 2) { checkDailyReset(); checkWeeklyReset(); }
    // Saturday 23:59 shop reset
    if (now.getDay()===6&&now.getHours()===23&&now.getMinutes()===59&&now.getSeconds()<3) { checkWeeklyReset(); toast('üîÑ Fun Shop weekly reset!','success'); }
    updateResetCountdown();
  };
  update();
  setInterval(update, 1000);
}

function updateResetCountdown() {
  const now = new Date();
  const day = now.getDay();
  const daysUntil = (6-day+7)%7 || 7;
  const sat = new Date(now);
  sat.setDate(now.getDate()+daysUntil);
  sat.setHours(23,59,0,0);
  const diff = sat - now;
  const d = Math.floor(diff/86400000);
  const h = Math.floor((diff%86400000)/3600000);
  const m = Math.floor((diff%3600000)/60000);
  const el = document.getElementById('reset-cd');
  if(el) el.textContent = `Resets in ${d}d ${h}h ${m}m`;
}

// ‚ïê‚ïê‚ïê‚ïê STARS BACKGROUND ‚ïê‚ïê‚ïê‚ïê
function generateStars() {
  const c = document.getElementById('stars-bg');
  if (!c) return;
  for (let i=0; i<80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random()*3+1;
    s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--dur:${2+Math.random()*4}s;--delay:${Math.random()*4}s`;
    c.appendChild(s);
  }
}

// ‚ïê‚ïê‚ïê‚ïê CURSOR ‚ïê‚ïê‚ïê‚ïê
function initCursor() {
  const cursor = document.getElementById('cursor');
  document.addEventListener('mousemove', e => {
    cursor.style.left = (e.clientX-10)+'px';
    cursor.style.top = (e.clientY-10)+'px';
  });
}

// ‚ïê‚ïê‚ïê‚ïê REFERRAL FROM URL ‚ïê‚ïê‚ïê‚ïê
function checkUrlReferral() {
  const params = new URLSearchParams(location.search);
  const ref = params.get('ref');
  if (ref) {
    const inp = document.getElementById('reg-ref');
    if (inp) { inp.value = ref; checkRefCode(); }
    switchAuthTab('register');
  }
}

window.addEventListener('load', checkUrlReferral);

// ‚ïê‚ïê‚ïê‚ïê AI ASSIST IN CUSTOMIZE ‚ïê‚ïê‚ïê‚ïê
// Allow generating goals/routine from AI
window.generateAiGoals = async function() {
  const key = localStorage.getItem('nox_api_key');
  if (!key) { toast('Add API key first','error'); return; }
  const prompt = 'Generate 8 daily productivity goals with points for a 21-year-old focused on financial independence, coding, and health. Format: GOAL:[name]|PTS:[num]|CAT:[category]';
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,messages:[{role:'user',content:prompt}]})
    });
    const data = await res.json();
    const text = data.content[0].text;
    const regex=/GOAL:(.+?)\|PTS:(\d+)\|CAT:(\w+)/g;
    let m, added=0;
    while((m=regex.exec(text))!==null){
      state.goals.push({id:uid(),name:m[1].trim(),points:parseInt(m[2]),category:m[3].trim(),note:''});
      added++;
    }
    if(added){save();renderAll();toast(`+${added} AI goals added`,'success');}
  } catch(e) { toast('AI error: '+e.message,'error'); }
};
</script>
</body>
</html>